{% extends "admin/base.html" %} {% block title %}Gestion de la base de données -
DEFITECH{% endblock %} {% block content %}
<!-- 
    ================================================================
    INTERFACE DE GESTION DE BASE DE DONNÉES
    ================================================================
    Permet de visualiser et gérer les tables avec :
    - Exploration de la structure des tables
    - Visualisation des données avec pagination
    - Recherche et filtrage
    - Éditeur SQL avec exécution de requêtes
    ================================================================
-->

<div
  class="container mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 max-w-[1800px]"
>
  <!-- ============================================
         EN-TÊTE PRINCIPAL
         ============================================ -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-4 sm:mb-6"
  >
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"
    >
      <!-- Titre et description -->
      <div class="flex-1 min-w-0">
        <h1
          class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 flex items-center gap-2 sm:gap-3"
        >
          <div class="p-2 bg-blue-50 rounded-lg flex-shrink-0">
            <i class="fas fa-database text-blue-600 text-lg sm:text-xl"></i>
          </div>
          <span class="truncate">Gestion de la base de données</span>
        </h1>
        <p class="text-sm text-gray-500 mt-2 hidden sm:block">
          Explorez et gérez les tables de votre base de données
        </p>
      </div>

      <!-- Bouton rafraîchir -->
      <button
        onclick="refreshData()"
        class="w-full sm:w-auto px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:scale-95 transition-all duration-200 shadow-sm hover:shadow flex items-center justify-center gap-2 text-sm font-medium"
        aria-label="Rafraîchir les données"
      >
        <i class="fas fa-sync-alt text-sm"></i>
        <span>Rafraîchir</span>
      </button>
    </div>
  </div>

  <!-- ============================================
         GRILLE PRINCIPALE (Sidebar + Contenu)
         ============================================ -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6">
    <!-- ============================================
             SIDEBAR : LISTE DES TABLES
             ============================================ -->
    <div class="lg:col-span-3">
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden lg:sticky lg:top-4"
      >
        <!-- En-tête sidebar -->
        <div
          class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200"
        >
          <h2
            class="text-base sm:text-lg font-semibold text-gray-900 flex items-center gap-2"
          >
            <i class="fas fa-table text-blue-600"></i>
            <span>Tables</span>
          </h2>
        </div>

        <!-- Liste des tables (scrollable) -->
        <div
          id="tablesList"
          class="divide-y divide-gray-100 max-h-[350px] sm:max-h-[400px] lg:max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar"
        >
          <!-- Loader initial -->
          <div class="p-8 text-center">
            <div
              class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-200 border-t-blue-600"
            ></div>
            <p class="text-sm text-gray-500 mt-3">Chargement...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================
             CONTENU PRINCIPAL
             ============================================ -->
    <div class="lg:col-span-9 space-y-4 sm:space-y-6">
      <!-- ========================================
                 SECTION : STRUCTURE DE LA TABLE
                 ======================================== -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
      >
        <!-- En-tête structure -->
        <div
          class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200"
        >
          <h2
            class="text-base sm:text-lg font-semibold text-gray-900 flex flex-wrap items-center gap-2"
          >
            <i class="fas fa-columns text-blue-600"></i>
            <span>Structure :</span>
            <span
              id="tableName"
              class="font-mono text-sm text-blue-600 bg-white px-3 py-1 rounded-md border border-blue-200 break-all"
            >
              Sélectionnez une table
            </span>
          </h2>
        </div>

        <!-- Tableau structure (scrollable horizontal) -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap"
                >
                  Colonne
                </th>
                <th
                  class="px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap"
                >
                  Type
                </th>
                <th
                  class="hidden sm:table-cell px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap"
                >
                  Nullable
                </th>
                <th
                  class="hidden md:table-cell px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap"
                >
                  Clé
                </th>
                <th
                  class="hidden lg:table-cell px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap"
                >
                  Par défaut
                </th>
              </tr>
            </thead>
            <tbody
              id="tableStructure"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Message initial -->
              <tr>
                <td colspan="5" class="px-6 py-12 text-center">
                  <i class="fas fa-info-circle text-gray-300 text-3xl mb-2"></i>
                  <p class="text-sm text-gray-500">
                    Sélectionnez une table pour voir sa structure
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ========================================
                 SECTION : DONNÉES DE LA TABLE
                 ======================================== -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
      >
        <!-- En-tête avec contrôles -->
        <div
          class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200"
        >
          <div
            class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3"
          >
            <!-- Titre -->
            <h2
              class="text-base sm:text-lg font-semibold text-gray-900 flex items-center gap-2"
            >
              <i class="fas fa-list-ol text-blue-600"></i>
              <span>Données de la table</span>
            </h2>

            <!-- Contrôles (recherche + limite) -->
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
              <!-- Champ de recherche -->
              <div class="relative flex-1 sm:flex-initial">
                <input
                  type="text"
                  id="searchData"
                  placeholder="Rechercher..."
                  class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm"
                  aria-label="Rechercher dans les données"
                />
                <i
                  class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"
                ></i>
              </div>

              <!-- Sélecteur de lignes -->
              <div
                class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-300"
              >
                <span
                  class="text-sm font-medium text-gray-700 whitespace-nowrap"
                  >Lignes :</span
                >
                <select
                  id="rowLimit"
                  class="border-0 bg-transparent text-sm font-medium text-gray-900 focus:ring-0 cursor-pointer pr-6"
                  aria-label="Nombre de lignes par page"
                >
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="250">250</option>
                  <option value="500">500</option>
                  <option value="1000">1000</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Tableau de données (scrollable) -->
        <div
          class="overflow-x-auto max-h-[500px] sm:max-h-[600px] overflow-y-auto custom-scrollbar"
        >
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
              <tr id="dataTableHeader">
                <th
                  class="px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Données
                </th>
              </tr>
            </thead>
            <tbody id="tableData" class="bg-white divide-y divide-gray-200">
              <!-- Message initial -->
              <tr>
                <td colspan="20" class="px-6 py-12 text-center">
                  <i class="fas fa-table text-gray-300 text-3xl mb-2"></i>
                  <p class="text-sm text-gray-500">
                    Sélectionnez une table pour voir les données
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Footer avec compteur et pagination -->
        <div
          class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
        >
          <!-- Compteur de lignes -->
          <div
            class="text-sm font-medium text-gray-700 text-center sm:text-left"
            id="rowCount"
          >
            <i class="fas fa-database mr-1 text-gray-400"></i>
            <span>0 ligne(s)</span>
          </div>

          <!-- Pagination -->
          <div id="pagination" class="flex justify-center sm:justify-end">
            <!-- Généré dynamiquement -->
          </div>
        </div>
      </div>

      <!-- ========================================
                 SECTION : ÉDITEUR SQL
                 ======================================== -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
      >
        <!-- En-tête éditeur -->
        <div
          class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200"
        >
          <h2
            class="text-base sm:text-lg font-semibold text-gray-900 flex items-center gap-2"
          >
            <i class="fas fa-terminal text-blue-600"></i>
            <span>Éditeur SQL</span>
          </h2>
          <p class="text-sm text-gray-500 mt-1">
            Exécutez des requêtes SQL personnalisées
          </p>
        </div>

        <!-- Zone d'édition -->
        <div class="p-4">
          <div class="mb-4">
            <textarea
              id="sqlEditor"
              rows="6"
              placeholder="Entrez votre requête SQL ici... (Ctrl+Entrée pour exécuter)"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-y"
              aria-label="Éditeur SQL"
            >
SELECT * FROM </textarea
            >
          </div>

          <!-- Contrôles -->
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"
          >
            <p class="text-xs text-gray-500 flex items-center gap-1">
              <i class="fas fa-keyboard"></i>
              <span>Raccourci : Ctrl+Entrée</span>
            </p>
            <button
              onclick="executeSqlQuery()"
              class="w-full sm:w-auto px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm font-medium shadow-sm hover:shadow"
            >
              <i class="fas fa-play text-sm"></i>
              <span>Exécuter</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================
     MODAL : DÉTAILS D'UNE LIGNE
     ================================================================ -->
<div
  id="rowDetailsModal"
  class="modal-overlay"
  onclick="handleModalBackdropClick(event, 'rowDetailsModal')"
  role="dialog"
  aria-modal="true"
  aria-labelledby="rowDetailsTitle"
>
  <div class="modal-container" onclick="event.stopPropagation()">
    <!-- En-tête modal -->
    <div class="modal-header">
      <h3 id="rowDetailsTitle" class="modal-title">
        <div class="modal-icon bg-blue-100">
          <i class="fas fa-info-circle text-blue-600"></i>
        </div>
        <span class="truncate">Détails de l'enregistrement</span>
      </h3>
      <button
        onclick="closeModal('rowDetailsModal')"
        class="modal-close-btn"
        aria-label="Fermer"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Contenu modal (scrollable) -->
    <div class="modal-body">
      <div id="rowDetailsContent" class="space-y-3">
        <!-- Généré dynamiquement -->
      </div>
    </div>

    <!-- Footer modal -->
    <div class="modal-footer">
      <button onclick="closeModal('rowDetailsModal')" class="btn-secondary">
        Fermer
      </button>
    </div>
  </div>
</div>

<!-- ================================================================
     MODAL : RÉSULTATS SQL
     ================================================================ -->
<div
  id="sqlResultsModal"
  class="modal-overlay"
  onclick="handleModalBackdropClick(event, 'sqlResultsModal')"
  role="dialog"
  aria-modal="true"
  aria-labelledby="sqlResultsTitle"
>
  <div
    class="modal-container modal-container-wide"
    onclick="event.stopPropagation()"
  >
    <!-- En-tête modal -->
    <div class="modal-header">
      <h3 id="sqlResultsTitle" class="modal-title">
        <div class="modal-icon bg-blue-100">
          <i class="fas fa-table text-blue-600"></i>
        </div>
        <span>Résultats de la requête</span>
      </h3>
      <button
        onclick="closeModal('sqlResultsModal')"
        class="modal-close-btn"
        aria-label="Fermer"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Contenu modal -->
    <div class="modal-body">
      <div id="sqlResultsContent">
        <!-- Généré dynamiquement -->
      </div>
    </div>

    <!-- Footer modal -->
    <div class="modal-footer">
      <button onclick="closeModal('sqlResultsModal')" class="btn-secondary">
        Fermer
      </button>
    </div>
  </div>
</div>

<!-- ================================================================
     MODAL : CONFIRMATION
     ================================================================ -->
<div
  id="confirmationModal"
  class="modal-overlay"
  role="dialog"
  aria-modal="true"
  aria-labelledby="confirmationTitle"
>
  <div
    class="modal-container modal-container-small"
    onclick="event.stopPropagation()"
  >
    <!-- En-tête modal -->
    <div class="modal-header bg-red-50">
      <h3 id="confirmationTitle" class="modal-title text-red-900">
        <div class="modal-icon bg-red-100">
          <i class="fas fa-exclamation-triangle text-red-600"></i>
        </div>
        <span id="confirmationTitleText">Confirmation</span>
      </h3>
    </div>

    <!-- Contenu modal -->
    <div class="modal-body">
      <div id="confirmationMessage" class="text-gray-700 space-y-2">
        <!-- Généré dynamiquement -->
      </div>
    </div>

    <!-- Footer modal -->
    <div class="modal-footer">
      <button id="confirmationCancelBtn" class="btn-secondary">Annuler</button>
      <button id="confirmationConfirmBtn" class="btn-danger">Confirmer</button>
    </div>
  </div>
</div>

<!-- Token CSRF -->
<div id="csrf_token" class="hidden">{{ csrf_token() }}</div>

<!-- ================================================================
     STYLES CSS
     ================================================================ -->
<style>
  /* ============================================
       ANIMATIONS
       ============================================ */
  @keyframes modal-enter {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-10px);
    }

    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  @keyframes fade-in {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  /* ============================================
       MODAL OVERLAY & CONTAINER
       ============================================ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
    animation: fade-in 0.2s ease;
  }

  .modal-container {
    background-color: white;
    border-radius: 1rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
    width: 100%;
    max-width: 48rem;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    animation: modal-enter 0.2s ease-out;
  }

  .modal-container-wide {
    max-width: 72rem;
  }

  .modal-container-small {
    max-width: 32rem;
  }

  /* ============================================
       MODAL SECTIONS
       ============================================ */
  .modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(to right, #eff6ff, #eef2ff);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    border-radius: 1rem 1rem 0 0;
  }

  .modal-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
  }

  .modal-icon {
    padding: 0.5rem;
    border-radius: 0.5rem;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close-btn {
    padding: 0.5rem;
    color: #9ca3af;
    border-radius: 0.5rem;
    transition: all 0.15s ease;
    flex-shrink: 0;
    cursor: pointer;
    background: transparent;
    border: none;
  }

  .modal-close-btn:hover {
    color: #4b5563;
    background-color: #f3f4f6;
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex-grow: 1;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    background-color: #f9fafb;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    border-radius: 0 0 1rem 1rem;
  }

  /* ============================================
       BOUTONS
       ============================================ */
  .btn-secondary {
    padding: 0.625rem 1.5rem;
    background-color: #e5e7eb;
    color: #374151;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.15s ease;
    cursor: pointer;
    border: none;
    font-size: 0.875rem;
  }

  .btn-secondary:hover {
    background-color: #d1d5db;
  }

  .btn-secondary:active {
    transform: scale(0.98);
  }

  .btn-danger {
    padding: 0.625rem 1.5rem;
    background-color: #dc2626;
    color: white;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.15s ease;
    cursor: pointer;
    border: none;
    font-size: 0.875rem;
  }

  .btn-danger:hover {
    background-color: #b91c1c;
  }

  .btn-danger:active {
    transform: scale(0.98);
  }

  /* ============================================
       TABLEAU - HOVER EFFECTS
       ============================================ */
  #tableData tr {
    transition: background-color 0.15s ease;
    cursor: pointer;
  }

  #tableData tr:hover {
    background-color: #f8fafc;
  }

  .table-cell-content {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (min-width: 768px) {
    .table-cell-content {
      max-width: 350px;
    }
  }

  /* ============================================
       PAGINATION
       ============================================ */
  .page-btn {
    min-width: 2.25rem;
    height: 2.25rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    background-color: white;
    color: #4b5563;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    padding: 0 0.5rem;
  }

  .page-btn:hover:not(.page-btn-active):not(:disabled) {
    background-color: #f3f4f6;
    border-color: #d1d5db;
  }

  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .page-btn-active {
    background-color: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .page-btn-active:hover {
    background-color: #2563eb;
    border-color: #2563eb;
  }

  .page-btn:first-child {
    border-top-left-radius: 0.5rem;
    border-bottom-left-radius: 0.5rem;
  }

  .page-btn:last-child {
    border-top-right-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
  }

  /* ============================================
       SIDEBAR - TABLE ITEMS
       ============================================ */
  .table-item {
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .table-item:hover {
    background-color: #f1f5f9;
  }

  @media (min-width: 1024px) {
    .table-item:hover {
      transform: translateX(4px);
    }
  }

  .table-item.active {
    background-color: #eff6ff;
    border-left: 4px solid #3b82f6 !important;
  }

  /* ============================================
       SCROLLBAR PERSONNALISÉE
       ============================================ */
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* ============================================
       RESPONSIVE - MOBILE
       ============================================ */
  @media (max-width: 639px) {
    .modal-container {
      max-height: 95vh;
      border-radius: 0.75rem;
    }

    .modal-header {
      padding: 1rem 1.25rem;
    }

    .modal-title {
      font-size: 1rem;
    }

    .modal-body {
      padding: 1.25rem;
    }

    .modal-footer {
      flex-direction: column-reverse;
      gap: 0.5rem;
    }

    .btn-secondary,
    .btn-danger {
      width: 100%;
    }
  }
</style>

<!-- ================================================================
     JAVASCRIPT
     ================================================================ -->
<script>
  /* ================================================================
         CONFIGURATION GLOBALE
         ================================================================ */
  const DB_MANAGER = {
    // État de l'application
    currentTable: null,
    currentPage: 1,
    totalPages: 1,
    rowLimit: 50,
    searchTerm: "",

    // Points de terminaison API
    endpoints: {
      getTables: "/admin/api/bdd/tables",
      getTableStructure: (tableName) =>
        `/admin/api/bdd/structure/${encodeURIComponent(tableName)}`,
      getTableData: (tableName, page = 1, limit = 50) =>
        `/admin/api/bdd/data/${encodeURIComponent(
          tableName
        )}?page=${page}&limit=${limit}`,
      executeSql: "/admin/api/bdd/execute",
    },

    // Constantes
    constants: {
      maxCellLength: 100,
      debounceDelay: 300,
      defaultLimit: 50,
      notificationDuration: 5000,
    },
  };

  /* ================================================================
         UTILITAIRES
         ================================================================ */
  const Utils = {
    /**
     * Échappe le HTML pour éviter les injections XSS
     */
    escapeHtml(unsafe) {
      if (typeof unsafe !== "string") return "";
      const div = document.createElement("div");
      div.textContent = unsafe;
      return div.innerHTML;
    },

    /**
     * Debounce pour limiter les appels de fonction
     */
    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },

    /**
     * Détecte si l'appareil est mobile
     */
    isMobile() {
      return window.innerWidth < 640;
    },

    /**
     * Affiche une notification toast (nécessite un gestionnaire de notifications)
     */
    showToast(message, type = "info") {
      // Si notificationManager existe, l'utiliser
      if (
        typeof notificationManager !== "undefined" &&
        notificationManager.showToast
      ) {
        notificationManager.showToast(message, type);
      } else {
        // Fallback : afficher dans la console
        console.log(`[${type.toUpperCase()}] ${message}`);
      }
    },
  };

  /* ================================================================
         GESTION DES MODALS
         ================================================================ */
  const ModalManager = {
    /**
     * Ouvre une modal
     */
    open(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;

      modal.classList.add("active");
      document.body.style.overflow = "hidden";

      // Focus sur le premier élément focusable
      setTimeout(() => {
        const focusable = modal.querySelector(
          "button, input, textarea, select"
        );
        if (focusable) focusable.focus();
      }, 100);
    },

    /**
     * Ferme une modal
     */
    close(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;

      modal.classList.remove("active");
      document.body.style.overflow = "auto";
    },

    /**
     * Gère le clic sur le backdrop (fond)
     */
    handleBackdropClick(event, modalId) {
      if (event.target.id === modalId) {
        this.close(modalId);
      }
    },
  };

  // Fonctions globales pour compatibilité
  function closeModal(modalId) {
    ModalManager.close(modalId);
  }

  function handleModalBackdropClick(event, modalId) {
    ModalManager.handleBackdropClick(event, modalId);
  }

  /* ================================================================
         INITIALISATION
         ================================================================ */
  document.addEventListener("DOMContentLoaded", function () {
    try {
      setupEventListeners();
      loadTables();
      setupKeyboardShortcuts();
      console.log("✓ Application initialisée avec succès");
    } catch (error) {
      console.error("✗ Erreur lors de l'initialisation:", error);
      Utils.showToast("Erreur lors du chargement de l'application", "error");
    }
  });

  /* ================================================================
         CONFIGURATION DES EVENT LISTENERS
         ================================================================ */
  function setupEventListeners() {
    // Gestion du changement de limite de lignes
    const rowLimitEl = document.getElementById("rowLimit");
    if (rowLimitEl) {
      rowLimitEl.addEventListener("change", function () {
        DB_MANAGER.rowLimit =
          parseInt(this.value) || DB_MANAGER.constants.defaultLimit;
        DB_MANAGER.currentPage = 1;
        if (DB_MANAGER.currentTable) {
          loadTableData();
        }
      });
    }

    // Gestion de la recherche avec debounce
    const searchInput = document.getElementById("searchData");
    if (searchInput) {
      const debouncedSearch = Utils.debounce(() => {
        DB_MANAGER.searchTerm = searchInput.value.trim();
        DB_MANAGER.currentPage = 1;
        if (DB_MANAGER.currentTable) {
          loadTableData();
        }
      }, DB_MANAGER.constants.debounceDelay);

      searchInput.addEventListener("input", debouncedSearch);
    }

    // Écouter l'événement keydown sur l'éditeur SQL
    const sqlEditor = document.getElementById("sqlEditor");
    if (sqlEditor) {
      sqlEditor.addEventListener("keydown", function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          e.preventDefault();
          executeSqlQuery();
        }
      });
    }
  }

  /* ================================================================
         CHARGEMENT DES TABLES
         ================================================================ */
  async function loadTables() {
    const tablesList = document.getElementById("tablesList");

    // Afficher le loader
    tablesList.innerHTML = `
            <div class="p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-200 border-t-blue-600"></div>
                <p class="text-sm text-gray-500 mt-3">Chargement des tables...</p>
            </div>
        `;

    try {
      const response = await fetch(DB_MANAGER.endpoints.getTables);

      if (!response.ok) {
        throw new Error(`Erreur HTTP: ${response.status}`);
      }

      const tables = await response.json();

      if (Array.isArray(tables) && tables.length > 0) {
        // Générer la liste des tables
        tablesList.innerHTML = tables
          .map(
            (tableName) => `
                    <div class="table-item p-4 cursor-pointer border-l-4 border-transparent hover:border-blue-400" 
                         onclick="selectTable('${Utils.escapeHtml(tableName)}')"
                         role="button"
                         tabindex="0"
                         onkeypress="if(event.key==='Enter') selectTable('${Utils.escapeHtml(
                           tableName
                         )}')">
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="p-2 bg-blue-50 rounded-lg flex-shrink-0">
                                    <i class="fas fa-table text-blue-600 text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-gray-900 truncate text-sm">
                                        ${Utils.escapeHtml(tableName)}
                                    </div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs flex-shrink-0"></i>
                        </div>
                    </div>
                `
          )
          .join("");

        // Sélectionner automatiquement la première table
        if (tables.length > 0) {
          selectTable(tables[0]);
        }
      } else {
        // Aucune table trouvée
        tablesList.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                        <p class="text-sm text-gray-500">Aucune table trouvée dans la base de données</p>
                    </div>
                `;
      }
    } catch (error) {
      console.error("Erreur lors du chargement des tables:", error);
      tablesList.innerHTML = `
                <div class="p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-3"></i>
                    <p class="text-sm text-red-600 font-medium">Erreur de chargement</p>
                    <p class="text-xs text-gray-500 mt-1">${Utils.escapeHtml(
                      error.message
                    )}</p>
                    <button 
                        onclick="loadTables()" 
                        class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Réessayer
                    </button>
                </div>
            `;
    }
  }

  /* ================================================================
         SÉLECTION D'UNE TABLE
         ================================================================ */
  async function selectTable(tableName) {
    if (!tableName) return;

    // Mettre à jour l'état
    DB_MANAGER.currentTable = tableName;
    DB_MANAGER.currentPage = 1;
    DB_MANAGER.searchTerm = "";

    // Réinitialiser le champ de recherche
    const searchInput = document.getElementById("searchData");
    if (searchInput) searchInput.value = "";

    // Mettre à jour l'interface (classe active)
    document.querySelectorAll(".table-item").forEach((el) => {
      el.classList.remove("active");
      // Vérifier si cet élément correspond à la table sélectionnée
      const tableNameInEl = el
        .querySelector(".font-semibold")
        ?.textContent.trim();
      if (tableNameInEl === tableName) {
        el.classList.add("active");
      }
    });

    // Mettre à jour le nom de la table dans l'en-tête
    const tableNameEl = document.getElementById("tableName");
    if (tableNameEl) tableNameEl.textContent = tableName;

    // Charger la structure et les données en parallèle
    await Promise.all([loadTableStructure(), loadTableData()]);
  }

  /* ================================================================
         CHARGEMENT DE LA STRUCTURE DE LA TABLE
         ================================================================ */
  async function loadTableStructure() {
    const tableStructure = document.getElementById("tableStructure");
    if (!tableStructure || !DB_MANAGER.currentTable) return;

    // Afficher le loader
    tableStructure.innerHTML = "";

    try {
      const response = await fetch(
        DB_MANAGER.endpoints.getTableStructure(DB_MANAGER.currentTable)
      );

      if (!response.ok) {
        throw new Error(`Erreur HTTP: ${response.status}`);
      }

      const columns = await response.json();

      if (Array.isArray(columns) && columns.length > 0) {
        // Générer les lignes de structure
        tableStructure.innerHTML = columns
          .map((column) => {
            // Vérifier si c'est une clé primaire ou étrangère
            const isPrimaryKey = column.primary_key || false;
            const isForeignKey =
              column.foreign_key_table && column.foreign_key_column;

            // Créer les badges
            const badges = [];
            if (isPrimaryKey) {
              badges.push(
                '<span class="ml-2 px-2 py-0.5 text-xs font-semibold bg-blue-100 text-blue-700 rounded-full">PK</span>'
              );
            }
            if (isForeignKey) {
              const fkTitle = `→ ${column.foreign_key_table}.${column.foreign_key_column}`;
              badges.push(
                `<span class="ml-1 px-2 py-0.5 text-xs font-semibold bg-purple-100 text-purple-700 rounded-full" title="${Utils.escapeHtml(
                  fkTitle
                )}">FK</span>`
              );
            }

            // Formater la valeur par défaut
            let defaultValue = column.default_value;
            let defaultValueHtml = "";

            if (defaultValue === null || defaultValue === undefined) {
              defaultValueHtml =
                '<span class="text-gray-400 italic">NULL</span>';
            } else if (defaultValue === "") {
              defaultValueHtml =
                '<span class="text-gray-400 italic">(vide)</span>';
            } else {
              defaultValueHtml = Utils.escapeHtml(String(defaultValue));
            }

            // Formater le type de données
            let typeHtml = Utils.escapeHtml(column.data_type || "unknown");
            if (column.character_maximum_length) {
              typeHtml += `(${column.character_maximum_length})`;
            } else if (column.numeric_precision) {
              typeHtml += `(${column.numeric_precision}`;
              if (column.numeric_scale) {
                typeHtml += `,${column.numeric_scale}`;
              }
              typeHtml += ")";
            }

            return `
                          <tr class="hover:bg-gray-50 transition-colors">
                              <td class="px-4 sm:px-6 py-3 sm:py-4 text-sm">
                                  <div class="flex items-center gap-2 flex-wrap">
                                      <span class="font-mono font-semibold text-gray-900">${Utils.escapeHtml(
                                        column.column_name
                                      )}</span>
                                      ${badges.join("")}
                                  </div>
                              </td>
                              <td class="px-4 sm:px-6 py-3 sm:py-4">
                                  <span class="inline-flex px-2.5 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded-md">
                                      ${typeHtml}
                                  </span>
                              </td>
                              <td class="hidden sm:table-cell px-4 sm:px-6 py-3 sm:py-4">
                                  ${
                                    column.is_nullable === "YES"
                                      ? '<span class="inline-flex px-2.5 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">Oui</span>'
                                      : '<span class="inline-flex px-2.5 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full">Non</span>'
                                  }
                              </td>
                              <td class="hidden md:table-cell px-4 sm:px-6 py-3 sm:py-4 text-sm text-gray-600">
                                  ${
                                    isPrimaryKey
                                      ? "PRIMARY KEY"
                                      : isForeignKey
                                      ? "FOREIGN KEY"
                                      : "-"
                                  }
                              </td>
                              <td class="hidden lg:table-cell px-4 sm:px-6 py-3 sm:py-4 text-sm font-mono text-gray-600">
                                  ${defaultValueHtml}
                          </td>
                      </tr>
                      `;
          })
          .join("");
      } else {
        // Aucune colonne trouvée
        tableStructure.innerHTML = `
                      <tr>
                          <td colspan="5" class="px-6 py-8 text-center">
                              <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                              <p class="text-sm text-gray-500">Aucune colonne trouvée dans cette table</p>
                          </td>
                      </tr>
                  `;
      }
    } catch (error) {
      console.error("Erreur lors du chargement de la structure:", error);
      tableStructure.innerHTML = `
                  <tr>
                      <td colspan="5" class="px-6 py-8 text-center">
                          <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-2"></i>
                          <p class="text-sm text-red-600 font-medium">Erreur lors du chargement de la structure</p>
                          <p class="text-xs text-gray-500 mt-1">${Utils.escapeHtml(
                            error.message
                          )}</p>
                          <button 
                              onclick="loadTableStructure()" 
                              class="mt-3 px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition-colors">
                              <i class="fas fa-sync-alt mr-1"></i>Réessayer
                          </button>
                      </td>
                  </tr>
              `;
    }
  }

  /* ================================================================
         CHARGEMENT DES DONNÉES DE LA TABLE
         ================================================================ */
  async function loadTableData() {
    const tableData = document.getElementById("tableData");
    const tableHeader = document.getElementById("dataTableHeader");
    const rowCountElement = document.getElementById("rowCount");
    const paginationElement = document.getElementById("pagination");

    if (
      !tableData ||
      !tableHeader ||
      !rowCountElement ||
      !DB_MANAGER.currentTable
    ) {
      console.error("Éléments du DOM non trouvés ou table non sélectionnée");
      return;
    }

    // Afficher le loader
    tableData.innerHTML = `
              <tr>
                  <td colspan="20" class="px-6 py-12 text-center">
                      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-200 border-t-blue-600"></div>
                      <p class="text-sm text-gray-500 mt-3">Chargement des données en cours...</p>
                  </td>
              </tr>
          `;

    // Réinitialiser l'en-tête et le compteur pendant le chargement
    tableHeader.innerHTML = "";
    rowCountElement.innerHTML = `
              <i class="fas fa-circle-notch fa-spin text-blue-500 mr-1"></i>
              <span>Chargement...</span>
          `;

    // Masquer la pagination pendant le chargement
    if (paginationElement) {
      paginationElement.innerHTML = "";
    }

    try {
      // Construire les paramètres de requête
      const params = new URLSearchParams({
        page: DB_MANAGER.currentPage,
        limit: DB_MANAGER.rowLimit,
      });

      if (DB_MANAGER.searchTerm) {
        params.append("search", DB_MANAGER.searchTerm);
      }

      // Afficher l'URL de l'endpoint dans la console pour le débogage
      const endpoint = DB_MANAGER.endpoints.getTableData(
        DB_MANAGER.currentTable,
        DB_MANAGER.currentPage,
        DB_MANAGER.rowLimit
      );
      console.log("Chargement des données depuis:", endpoint);

      // Effectuer la requête avec le bon endpoint
      const response = await fetch(endpoint);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(
          `Erreur HTTP ${response.status}: ${errorText || "Aucun détail"}`
        );
      }

      const data = await response.json();
      console.log("Données reçues:", data);

      // Vérifier si nous avons des données
      if (Array.isArray(data) && data.length > 0) {
        // Extraire les colonnes à partir de la première ligne
        const columns = Object.keys(data[0]);

        // Générer l'en-tête du tableau
        tableHeader.innerHTML = `
                      <tr>
                          ${columns
                            .map(
                              (column) => `
                              <th class="px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 whitespace-nowrap">
                                  <div class="flex items-center gap-2">
                                      <span class="truncate">${Utils.escapeHtml(
                                        column
                                      )}</span>
                                  </div>
                              </th>
                          `
                            )
                            .join("")}
                      </tr>
                  `;

        // Générer les lignes de données
        tableData.innerHTML = data
          .map((row) => {
            const cells = columns
              .map((column) => {
                const value = row[column];
                return `
                              <td class="px-4 sm:px-6 py-3 sm:py-4 text-sm text-gray-900">
                                  <div class="table-cell-content">${formatCellValue(
                                    value,
                                    { type: "text" }
                                  )}</div>
                              </td>
                          `;
              })
              .join("");

            // Échapper les guillemets pour l'attribut onclick
            const rowDataJson = JSON.stringify(row)
              .replace(/'/g, "\\'")
              .replace(/"/g, "&quot;");

            return `
                          <tr class="cursor-pointer hover:bg-gray-50"
                              onclick='showRowDetails(${rowDataJson})'
                              role="button"
                              tabindex="0"
                              onkeypress="if(event.key==='Enter') showRowDetails(${rowDataJson})">
                              ${cells}
                          </tr>
                      `;
          })
          .join("");

        // Mettre à jour le compteur de lignes
        const totalRows = data.length; // Note: L'API devrait retourner le total des lignes
        rowCountElement.innerHTML = `
                      <i class="fas fa-database mr-1 text-gray-400"></i>
                      <span>${totalRows.toLocaleString(
                        "fr-FR"
                      )} ligne(s) affichée(s)</span>
                  `;

        // Mettre à jour la pagination
        updatePagination(totalRows);
      } else {
        // Aucune donnée disponible
        tableData.innerHTML = `
                      <tr>
                          <td colspan="20" class="px-6 py-16 text-center">
                              <i class="fas fa-inbox text-gray-300 text-5xl mb-3"></i>
                              <p class="text-sm text-gray-500 font-medium">
                                  ${
                                    DB_MANAGER.searchTerm
                                      ? `Aucun résultat pour "${Utils.escapeHtml(
                                          DB_MANAGER.searchTerm
                                        )}"`
                                      : "Aucune donnée disponible dans cette table"
                                  }
                              </p>
                              ${
                                DB_MANAGER.searchTerm
                                  ? `
                                  <button 
                                      onclick="DB_MANAGER.searchTerm = ''; loadTableData()" 
                                      class="mt-3 px-4 py-1.5 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors">
                                      <i class="fas fa-times mr-1"></i>Effacer la recherche
                                  </button>
                              `
                                  : ""
                              }
                          </td>
                      </tr>
                  `;

        // Réinitialiser l'en-tête et le compteur
        tableHeader.innerHTML = "";
        rowCountElement.innerHTML = `
                      <i class="fas fa-database mr-1 text-gray-400"></i>
                      <span>0 ligne(s)</span>
                  `;

        // Réinitialiser la pagination
        if (paginationElement) {
          paginationElement.innerHTML = "";
        }
      }
    } catch (error) {
      console.error("Erreur lors du chargement des données:", error);

      // Afficher un message d'erreur détaillé
      tableData.innerHTML = `
                  <tr>
                      <td colspan="20" class="px-6 py-12 text-center">
                          <i class="fas fa-exclamation-triangle text-red-400 text-5xl mb-3"></i>
                          <p class="text-sm text-red-600 font-medium">Erreur lors du chargement des données</p>
                          <p class="text-xs text-gray-500 mt-1">${Utils.escapeHtml(
                            error.message
                          )}</p>
                          <button 
                              onclick="loadTableData()" 
                              class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors">
                              <i class="fas fa-sync-alt mr-2"></i>Réessayer
                          </button>
                      </td>
                  </tr>
              `;

      // Mettre à jour le compteur avec un message d'erreur
      rowCountElement.innerHTML = `
                  <i class="fas fa-exclamation-circle text-red-400 mr-1"></i>
                  <span class="text-red-600">Erreur de chargement</span>
              `;

      // Vider l'en-tête en cas d'erreur
      tableHeader.innerHTML = "";

      // Vider la pagination en cas d'erreur
      if (paginationElement) {
        paginationElement.innerHTML = "";
      }
    }
  }

  /* ================================================================
         FORMATAGE DES VALEURS DE CELLULE
         ================================================================ */
  function formatCellValue(value, column) {
    // Valeur NULL ou undefined
    if (value === null || value === undefined) {
      return '<span class="text-gray-400 italic text-sm">NULL</span>';
    }

    // Valeur booléenne
    if (typeof value === "boolean") {
      return value
        ? '<span class="inline-flex px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700 rounded-full">Oui</span>'
        : '<span class="inline-flex px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 rounded-full">Non</span>';
    }

    // Valeur de type date
    if (column.type && column.type.toLowerCase().includes("date")) {
      const date = new Date(value);
      if (!isNaN(date.getTime())) {
        return date.toLocaleString("fr-FR", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    }

    // Valeur objet (JSON)
    if (typeof value === "object") {
      return `<code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded">${Utils.escapeHtml(
        JSON.stringify(value)
      )}</code>`;
    }

    // Chaîne de caractères (avec troncature)
    const strValue = String(value);
    const maxLength = Utils.isMobile()
      ? 50
      : DB_MANAGER.constants.maxCellLength;

    if (strValue.length > maxLength) {
      return `<span title="${Utils.escapeHtml(strValue)}">${Utils.escapeHtml(
        strValue.substring(0, maxLength)
      )}...</span>`;
    }

    return Utils.escapeHtml(strValue);
  }

  /* ================================================================
         MISE À JOUR DE LA PAGINATION
         ================================================================ */
  function updatePagination(totalRows) {
    DB_MANAGER.totalPages = Math.ceil(totalRows / DB_MANAGER.rowLimit);
    const paginationElement = document.getElementById("pagination");

    // Pas de pagination si une seule page ou moins
    if (!paginationElement || DB_MANAGER.totalPages <= 1) {
      if (paginationElement) paginationElement.innerHTML = "";
      return;
    }

    let html = '<div class="inline-flex rounded-lg shadow-sm -space-x-px">';

    // Bouton Précédent
    html += `
              <button
                  onclick="changePage('prev')"
                  ${DB_MANAGER.currentPage === 1 ? "disabled" : ""}
                  class="page-btn"
                  aria-label="Page précédente">
                  <i class="fas fa-chevron-left"></i>
              </button>
          `;

    // Numéros de pages (adaptés au mobile)
    const maxVisible = Utils.isMobile() ? 3 : 5;
    let startPage = Math.max(
      1,
      DB_MANAGER.currentPage - Math.floor(maxVisible / 2)
    );
    let endPage = Math.min(DB_MANAGER.totalPages, startPage + maxVisible - 1);

    // Ajuster startPage si nécessaire
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    // Première page si elle n'est pas dans la plage visible
    if (startPage > 1) {
      html += `<button onclick="changePage(1)" class="page-btn">1</button>`;
      if (startPage > 2) {
        html += `<span class="page-btn" disabled>...</span>`;
      }
    }

    // Pages visibles
    for (let i = startPage; i <= endPage; i++) {
      html += `
                  <button
                      onclick="changePage(${i})"
                      class="page-btn ${
                        i === DB_MANAGER.currentPage ? "page-btn-active" : ""
                      }"
                      aria-label="Page ${i}"
                      ${
                        i === DB_MANAGER.currentPage
                          ? 'aria-current="page"'
                          : ""
                      }>
                      ${i}
                  </button>
              `;
    }

    // Dernière page si elle n'est pas dans la plage visible
    if (endPage < DB_MANAGER.totalPages) {
      if (endPage < DB_MANAGER.totalPages - 1) {
        html += `<span class="page-btn" disabled>...</span>`;
      }
      html += `<button onclick="changePage(${DB_MANAGER.totalPages})" class="page-btn">${DB_MANAGER.totalPages}</button>`;
    }

    // Bouton Suivant
    html += `
              <button
                  onclick="changePage('next')"
                  ${
                    DB_MANAGER.currentPage === DB_MANAGER.totalPages
                      ? "disabled"
                      : ""
                  }
                  class="page-btn"
                  aria-label="Page suivante">
                  <i class="fas fa-chevron-right"></i>
              </button>
          `;

    html += "</div>";
    paginationElement.innerHTML = html;
  }

  /* ================================================================
         CHANGEMENT DE PAGE
         ================================================================ */
  function changePage(page) {
    let newPage = DB_MANAGER.currentPage;

    if (page === "prev" && DB_MANAGER.currentPage > 1) {
      newPage = DB_MANAGER.currentPage - 1;
    } else if (
      page === "next" &&
      DB_MANAGER.currentPage < DB_MANAGER.totalPages
    ) {
      newPage = DB_MANAGER.currentPage + 1;
    } else if (
      typeof page === "number" &&
      page >= 1 &&
      page <= DB_MANAGER.totalPages
    ) {
      newPage = page;
    } else {
      return; // Page invalide
    }

    DB_MANAGER.currentPage = newPage;
    loadTableData();

    // Scroll vers le haut du tableau
    const tableContainer = document.querySelector(".overflow-x-auto");
    if (tableContainer) {
      tableContainer.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  /* ================================================================
         AFFICHAGE DES DÉTAILS D'UNE LIGNE
         ================================================================ */
  function showRowDetails(rowData) {
    const content = document.getElementById("rowDetailsContent");
    if (!content) return;

    // Générer le contenu
    content.innerHTML = Object.entries(rowData)
      .map(([key, value]) => {
        let displayValue = value;

        // Formatter la valeur selon son type
        if (value === null || value === undefined) {
          displayValue =
            '<span class="text-gray-400 italic text-sm">NULL</span>';
        } else if (typeof value === "boolean") {
          displayValue = value
            ? '<span class="inline-flex px-2.5 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">Vrai</span>'
            : '<span class="inline-flex px-2.5 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full">Faux</span>';
        } else if (typeof value === "object") {
          displayValue = `<pre class="bg-gray-50 p-4 rounded-lg overflow-auto max-h-60 text-xs border border-gray-200 font-mono">${Utils.escapeHtml(
            JSON.stringify(value, null, 2)
          )}</pre>`;
        } else if (
          typeof value === "string" &&
          (key.toLowerCase().includes("date") ||
            key.toLowerCase().includes("time") ||
            key.toLowerCase().includes("at"))
        ) {
          const date = new Date(value);
          if (!isNaN(date.getTime())) {
            displayValue = `
                          <div class="flex items-center gap-2">
                              <i class="fas fa-calendar-alt text-gray-400 text-sm"></i>
                              <span class="text-sm">${date.toLocaleString(
                                "fr-FR"
                              )}</span>
                          </div>
                      `;
          } else {
            displayValue = `<div class="break-all text-sm">${Utils.escapeHtml(
              String(value)
            )}</div>`;
          }
        } else {
          displayValue = `<div class="break-all text-sm">${Utils.escapeHtml(
            String(value)
          )}</div>`;
        }

        return `
                  <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-blue-300 transition-colors">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                          <i class="fas fa-tag text-blue-500 text-xs"></i>
                          <span class="truncate">${Utils.escapeHtml(key)}</span>
                      </div>
                      <div class="text-gray-900">${displayValue}</div>
                  </div>
              `;
      })
      .join("");

    // Ouvrir la modal
    ModalManager.open("rowDetailsModal");
  }

  /* ================================================================
         RAFRAÎCHISSEMENT DES DONNÉES
         ================================================================ */
  function refreshData() {
    if (DB_MANAGER.currentTable) {
      Promise.all([loadTableStructure(), loadTableData()])
        .then(() => {
          Utils.showToast("Données rafraîchies avec succès", "success");
        })
        .catch((error) => {
          console.error("Erreur lors du rafraîchissement:", error);
          Utils.showToast("Erreur lors du rafraîchissement", "error");
        });
    } else {
      loadTables();
    }
  }

  /* ================================================================
         MODAL DE CONFIRMATION
         ================================================================ */
  function showConfirmationDialog(
    title,
    message,
    confirmText = "Confirmer",
    cancelText = "Annuler"
  ) {
    return new Promise((resolve) => {
      const modal = document.getElementById("confirmationModal");
      const titleEl = document.getElementById("confirmationTitleText");
      const messageEl = document.getElementById("confirmationMessage");
      const confirmBtn = document.getElementById("confirmationConfirmBtn");
      const cancelBtn = document.getElementById("confirmationCancelBtn");

      if (!modal || !titleEl || !messageEl || !confirmBtn || !cancelBtn) {
        resolve(false);
        return;
      }

      // Remplir le contenu
      titleEl.textContent = title;
      messageEl.innerHTML = message
        .split("\n")
        .map((part) => `<p>${Utils.escapeHtml(part)}</p>`)
        .join("");
      confirmBtn.textContent = confirmText;
      cancelBtn.textContent = cancelText;

      // Gestionnaires d'événements
      const handleConfirm = () => {
        cleanup();
        resolve(true);
      };

      const handleCancel = () => {
        cleanup();
        resolve(false);
      };

      const cleanup = () => {
        confirmBtn.removeEventListener("click", handleConfirm);
        cancelBtn.removeEventListener("click", handleCancel);
        ModalManager.close("confirmationModal");
      };

      confirmBtn.addEventListener("click", handleConfirm);
      cancelBtn.addEventListener("click", handleCancel);

      // Ouvrir la modal
      ModalManager.open("confirmationModal");
    });
  }

  /* ================================================================
         VÉRIFICATION DES REQUÊTES DANGEREUSES
         ================================================================ */
  function isDangerousQuery(query) {
    const dangerousCommands = [
      "DROP TABLE",
      "DROP DATABASE",
      "TRUNCATE TABLE",
      "DELETE FROM",
      "UPDATE",
      "ALTER TABLE",
      "CREATE OR REPLACE",
      "GRANT",
      "REVOKE",
      "LOCK TABLE",
    ];

    const upperQuery = query.toUpperCase();
    return dangerousCommands.some((cmd) => upperQuery.includes(cmd));
  }

  /* ================================================================
         EXÉCUTION D'UNE REQUÊTE SQL
         ================================================================ */
  async function executeSqlQuery() {
    const editor = document.getElementById("sqlEditor");
    if (!editor) {
      Utils.showToast("Éditeur SQL non trouvé", "error");
      return;
    }

    const query = editor.value.trim();
    if (!query) {
      Utils.showToast("Veuillez saisir une requête SQL", "warning");
      return;
    }

    // Vérifier si c'est une commande potentiellement dangereuse
    if (isDangerousQuery(query)) {
      const queryPreview =
        query.substring(0, 100) + (query.length > 100 ? "..." : "");
      const isConfirmed = await showConfirmationDialog(
        "Opération potentiellement dangereuse",
        `Cette commande peut modifier ou supprimer des données.\n\nÊtes-vous sûr de vouloir exécuter cette commande ?\n\nCommande : ${queryPreview}`,
        "Exécuter",
        "Annuler"
      );

      if (!isConfirmed) {
        Utils.showToast("Commande annulée", "warning");
        return;
      }
    }

    // Créer l'overlay de chargement
    const loadingOverlay = document.createElement("div");
    loadingOverlay.id = "sql-loading";
    loadingOverlay.className = "modal-overlay active";
    loadingOverlay.innerHTML = `
              <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                  <div class="flex items-center justify-center mb-4">
                      <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-200 border-t-blue-600"></div>
                  </div>
                  <p class="text-center text-gray-700 text-base mb-3 font-medium">Exécution de la requête...</p>
                  <pre class="p-3 bg-gray-100 rounded text-xs overflow-auto max-h-40 border border-gray-200">${Utils.escapeHtml(
                    query
                  )}</pre>
              </div>
          `;
    document.body.appendChild(loadingOverlay);

    try {
      const csrfToken = document.getElementById("csrf_token")?.textContent;

      const response = await fetch(DB_MANAGER.endpoints.executeSql, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken || "",
        },
        body: JSON.stringify({ query }),
      });

      const result = await response.json();

      // Retirer le loader
      if (loadingOverlay.parentNode) {
        loadingOverlay.remove();
      }

      if (!response.ok) {
        throw new Error(
          result.error || "Erreur lors de l'exécution de la requête"
        );
      }

      // Afficher les résultats
      if (result.results && result.results.length > 0) {
        displaySqlResults(result);
      } else {
        // Requête sans résultats (INSERT, UPDATE, DELETE, etc.)
        const affectedRows = result.row_count || 0;
        const lastId = result.last_insert_id
          ? ` ID inséré : ${result.last_insert_id}`
          : "";
        Utils.showToast(
          `Requête exécutée avec succès. ${affectedRows} ligne(s) affectée(s).${lastId}`,
          "success"
        );

        // Recharger les données si la table actuelle est affectée
        if (
          DB_MANAGER.currentTable &&
          query.toLowerCase().includes(DB_MANAGER.currentTable.toLowerCase())
        ) {
          setTimeout(() => refreshData(), 500);
        }
      }
    } catch (error) {
      console.error("Erreur lors de l'exécution de la requête SQL:", error);

      // Retirer le loader en cas d'erreur
      const loader = document.getElementById("sql-loading");
      if (loader) loader.remove();

      Utils.showToast(`Erreur : ${error.message}`, "error");
    }
  }

  /* ================================================================
         AFFICHAGE DES RÉSULTATS SQL
         ================================================================ */
  function displaySqlResults(result) {
    const content = document.getElementById("sqlResultsContent");
    if (!content) return;

    const rowCount = result.row_count || result.results.length;

    content.innerHTML = `
              <div class="mb-4">
                  <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg text-sm flex items-start gap-3">
                      <i class="fas fa-check-circle text-green-600 mt-0.5 flex-shrink-0"></i>
                      <div>
                          <p class="font-medium">Requête exécutée avec succès</p>
                          <p class="text-xs mt-1">${rowCount.toLocaleString(
                            "fr-FR"
                          )} ligne(s) retournée(s)</p>
                      </div>
                  </div>
              </div>
              <div class="overflow-auto rounded-lg border border-gray-200 max-h-[60vh] custom-scrollbar">
                  <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50 sticky top-0">
                          <tr>
                              ${Object.keys(result.results[0] || {})
                                .map(
                                  (col) =>
                                    `<th class="px-4 sm:px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                                      ${Utils.escapeHtml(col)}
                                  </th>`
                                )
                                .join("")}
                          </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                          ${result.results
                            .map(
                              (row) => `
                              <tr class="hover:bg-gray-50 transition-colors">
                                  ${Object.values(row)
                                    .map(
                                      (cell) => `
                                      <td class="px-4 sm:px-6 py-3 sm:py-4 text-sm text-gray-900">
                                          ${formatCellValue(cell, {
                                            type: "text",
                                          })}
                                      </td>
                                  `
                                    )
                                    .join("")}
                              </tr>
                          `
                            )
                            .join("")}
                      </tbody>
                  </table>
              </div>
          `;

    ModalManager.open("sqlResultsModal");
  }

  /* ================================================================
         CONFIGURATION DES RACCOURCIS CLAVIER
         ================================================================ */
  function setupKeyboardShortcuts() {
    document.addEventListener("keydown", function (event) {
      // Échap : fermer toutes les modals
      if (event.key === "Escape") {
        ModalManager.close("rowDetailsModal");
        ModalManager.close("sqlResultsModal");
        ModalManager.close("confirmationModal");
      }

      // Ctrl+R : rafraîchir les données
      if ((event.ctrlKey || event.metaKey) && event.key === "r") {
        const activeElement = document.activeElement;
        // Ne pas intercepter si on est dans un input/textarea
        if (
          !activeElement ||
          !["INPUT", "TEXTAREA"].includes(activeElement.tagName)
        ) {
          event.preventDefault();
          refreshData();
        }
      }
    });
  }

  /* ================================================================
         GESTION DU SCROLL DU BODY AVEC LES MODALS
         ================================================================ */
  (function setupModalObservers() {
    const modalIds = [
      "rowDetailsModal",
      "sqlResultsModal",
      "confirmationModal",
    ];

    modalIds.forEach((modalId) => {
      const modal = document.getElementById(modalId);
      if (modal) {
        // Observer les changements de classe pour gérer le scroll du body
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.attributeName === "class") {
              const isActive = modal.classList.contains("active");
              document.body.style.overflow = isActive ? "hidden" : "auto";
            }
          });
        });

        observer.observe(modal, {
          attributes: true,
          attributeFilter: ["class"],
        });
      }
    });
  })();
</script>

{% endblock %}
