{% extends "admin/base.html" %}
{% block title %}Gestion Emploi du Temps{% endblock %}
{% block content %}

<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Header -->
    <div class="mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-calendar-alt text-blue-600 mr-3"></i>
            Gestion de l'emploi du temps
        </h1>
        <p class="mt-2 text-sm text-gray-600">Créez et gérez les emplois du temps par filière et année</p>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Header with Import/Export -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <h2 class="text-xl font-semibold text-white">Créer / Modifier un emploi du temps</h2>
                <div class="flex flex-wrap gap-2">
                    <label
                        class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg cursor-pointer transition-colors backdrop-blur-sm border border-white/20">
                        <i class="fas fa-file-import mr-2"></i>
                        <span class="text-sm font-medium">Importer JSON</span>
                        <input type="file" id="import-json" accept=".json" class="hidden"
                            onchange="handleFileImport('json')">
                    </label>
                    <label
                        class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg cursor-pointer transition-colors backdrop-blur-sm border border-white/20">
                        <i class="fas fa-file-excel mr-2"></i>
                        <span class="text-sm font-medium">Importer Excel</span>
                        <input type="file" id="import-excel" accept=".xlsx,.xls" class="hidden"
                            onchange="handleFileImport('excel')">
                    </label>
                    <button type="button" onclick="exportToExcel()"
                        class="inline-flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors shadow-md">
                        <i class="fas fa-download mr-2"></i>
                        <span class="text-sm font-medium">Exporter Excel</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Message -->
        <div id="import-status" class="hidden mx-6 mt-6"></div>

        <!-- Filter Form -->
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-graduation-cap text-gray-400 mr-1"></i>
                        Filière
                    </label>
                    <select name="filiere"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        required>
                        <option value="">-- Choisir une filière --</option>
                        {% for f in filieres %}
                        <option value="{{ f.id }}" {% if selected_filiere==f.id|string %}selected{% endif %}>{{ f.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar text-gray-400 mr-1"></i>
                        Année
                    </label>
                    <select name="annee"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        required>
                        <option value="">-- Choisir une année --</option>
                        {% for a in annees %}
                        <option value="{{ a.id }}" {% if selected_annee==a.id|string %}selected{% endif %}>{{ a.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="sm:col-span-2 lg:col-span-2 flex items-end">
                    <button type="submit"
                        class="w-full px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-md">
                        <i class="fas fa-search mr-2"></i>
                        Afficher l'emploi du temps
                    </button>
                </div>
            </form>
        </div>

        {% if selected_filiere and selected_annee %}
        <!-- Schedule Form -->
        <form method="post" action="{{ url_for('admin.admin_emploi_temps', filiere=selected_filiere, annee=selected_annee) }}"
            class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Desktop View -->
            <div class="hidden lg:block overflow-x-auto">
                <table class="min-w-full border-collapse border border-gray-300 shadow-sm">
                    <thead>
                        <tr class="bg-gradient-to-r from-gray-100 to-gray-200">
                            <th
                                class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border border-gray-300 w-32">
                                Horaire
                            </th>
                            {% for jour in jours %}
                            <th
                                class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border border-gray-300">
                                {{ jour }}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for horaire in horaires %}
                        <tr class="hover:bg-blue-50 transition-colors">
                            <td class="px-4 py-3 text-sm font-bold text-gray-900 border border-gray-300 bg-gray-50">
                                {{ horaire }}
                            </td>
                            {% for jour in jours %}
                            <td class="px-3 py-3 border border-gray-300">
                                {% set creneau = emploi_dict[jour][horaire] %}
                                <div class="space-y-2">
                                    <!-- Heures -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Début</label>
                                            <input type="time" name="heure_debut_{{ jour }}_{{ horaire }}"
                                                class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                value="{{ creneau.heure_debut.strftime('%H:%M') if creneau and creneau.heure_debut else '' }}">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Fin</label>
                                            <input type="time" name="heure_fin_{{ jour }}_{{ horaire }}"
                                                class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                value="{{ creneau.heure_fin.strftime('%H:%M') if creneau and creneau.heure_fin else '' }}">
                                        </div>
                                    </div>

                                    <!-- Matière -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Matière</label>
                                        <select name="matiere_{{ jour }}_{{ horaire }}"
                                            class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Sélectionner --</option>
                                            {% for m in matieres %}
                                            <option value="{{ m.id }}" {% if creneau and creneau.matiere and
                                                creneau.matiere.id==m.id %}selected{% endif %}>
                                                {{ m.nom }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Salle
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Salle</label>
                                        <input type="text" name="salle_{{ jour }}_{{ horaire }}"
                                            class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="Ex: A101" value="{{ creneau.salle if creneau else '' }}">
                                    </div> -->
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile/Tablet View -->
            <div class="lg:hidden space-y-6">
                {% for jour in jours %}
                <div class="border border-gray-300 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-4 py-3">
                        <h3 class="text-lg font-bold text-white">{{ jour }}</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        {% for horaire in horaires %}
                        {% set creneau = emploi_dict[jour][horaire] %}
                        <div class="p-4 bg-white hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-bold text-gray-900 text-sm">{{ horaire }}</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                    Créneau
                                </span>
                            </div>

                            <div class="space-y-3">
                                <!-- Heures -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                            <i class="far fa-clock text-gray-400 mr-1"></i>Début
                                        </label>
                                        <input type="time" name="heure_debut_{{ jour }}_{{ horaire }}"
                                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            value="{{ creneau.heure_debut.strftime('%H:%M') if creneau and creneau.heure_debut else '' }}">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                            <i class="far fa-clock text-gray-400 mr-1"></i>Fin
                                        </label>
                                        <input type="time" name="heure_fin_{{ jour }}_{{ horaire }}"
                                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            value="{{ creneau.heure_fin.strftime('%H:%M') if creneau and creneau.heure_fin else '' }}">
                                    </div>
                                </div>

                                <!-- Matière -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                        <i class="fas fa-book text-gray-400 mr-1"></i>Matière
                                    </label>
                                    <select name="matiere_{{ jour }}_{{ horaire }}"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">-- Sélectionner une matière --</option>
                                        {% for m in matieres %}
                                        <option value="{{ m.id }}" {% if creneau and creneau.matiere and
                                            creneau.matiere.id==m.id %}selected{% endif %}>
                                            {{ m.nom }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Salle
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                        <i class="fas fa-door-open text-gray-400 mr-1"></i>Salle
                                    </label>
                                    <input type="text" name="salle_{{ jour }}_{{ horaire }}"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Ex: A101, B205..." value="{{ creneau.salle if creneau else '' }}">
                                </div> -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Submit Button -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row gap-3 justify-end">
                    <button type="button" onclick="window.location.reload()"
                        class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
                        <i class="fas fa-undo mr-2"></i>Réinitialiser
                    </button>
                    <button type="submit"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors shadow-md">
                        <i class="fas fa-check-circle mr-2"></i>Enregistrer l'emploi du temps
                    </button>
                </div>
            </div>
        </form>
        {% else %}
        <!-- Empty State -->
        <div class="p-12 text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-6">
                <i class="fas fa-calendar-alt text-4xl text-blue-600"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun emploi du temps sélectionné</h3>
            <p class="text-gray-600">Veuillez sélectionner une filière et une année pour commencer</p>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <!-- Script for Cloudinary Upload -->
            <script src="{{ url_for('static', filename='js/cloudinary_uploader.js') }}"></script>
            <script>
                function showStatus(message, isError = false) {
                    const statusDiv = document.getElementById('import-status');
                    statusDiv.innerHTML = `
                        <div class="flex items-center p-4 rounded-lg ${isError ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}">
                            <i class="fas ${isError ? 'fa-exclamation-circle text-red-600' : 'fa-check-circle text-green-600'} text-xl mr-3"></i>
                            <span class="${isError ? 'text-red-700' : 'text-green-700'} font-medium">${message}</span>
                        </div>
                    `;
                    statusDiv.classList.remove('hidden');
            
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 5000);
                }
            
                // Cloudinary upload handler for JSON/Excel
                async function triggerCloudinaryUpload(type) {
                     // Determine the hidden input ID and feedback ID based on type
                     // We need to create hidden elements dynamically or reuse existing ones?
                     // Let's create a temporary hidden input for the file picker if not exists
                     let fileInput = document.getElementById(`file-upload-${type}`);
                     if (!fileInput) {
                         // This shouldn't happen if we updated the HTML correctly.
                         console.error("File input not found");
                         return;
                     }
                     fileInput.click();
                }

                // Initial setup for Cloudinary inputs is done via 'attachCloudinaryUpload' usually.
                // But here we have custom buttons triggering the file input.
                // We can use the 'attachCloudinaryUpload' helper on hidden inputs.
                
                document.addEventListener('DOMContentLoaded', function() {
                     // Attach Cloudinary to hidden inputs
                     // We use 'raw' for JSON/Excel
                     attachCloudinaryUpload('file-upload-json', 'file_url_json', 'documents_upload', 'import-status', 'raw'); 
                     attachCloudinaryUpload('file-upload-excel', 'file_url_excel', 'documents_upload', 'import-status', 'raw');
                     
                     // Listen for the hidden url input change to trigger the backend import
                     const urlInputJson = document.getElementById('file_url_json');
                     if(urlInputJson) {
                         // We need to observe changes to the value, but 'change' event doesn't fire on programmatic change.
                         // Modified 'attachCloudinaryUpload' or use MutationObserver on feedback?
                         // The feedback element 'import-status' gets updated with "Upload terminé!".
                         const observer = new MutationObserver(function(mutations) {
                            if (document.getElementById('import-status').textContent.includes('Upload terminé')) {
                                // Checking which one finished?
                                if (urlInputJson.value) {
                                    handleBackendImport(urlInputJson.value, 'json');
                                    urlInputJson.value = ''; // Reset
                                }
                            }
                         });
                         observer.observe(document.getElementById('import-status'), { childList: true, characterData: true, subtree: true });
                     }
                     
                     const urlInputExcel = document.getElementById('file_url_excel');
                     if(urlInputExcel) {
                         // Similar observer logic... simpler: just check both? 
                         // Or use a dedicated feedback div for each to distinguish.
                     }
                });

                // REVISION: The above approach with shared feedback div is messy. 
                async function handleFileImport(type) {
                    const fileInput = document.getElementById(type === 'json' ? 'import-json' : 'import-excel');
                    const file = fileInput.files[0];
                    if (!file) return;

                    showStatus(`Upload vers Cloudinary en cours...`, false);
                    
                    try {
                        // Direct usage of global uploadToCloudinary with 'documents_upload' preset and 'raw' resource type
                        // We use 'raw' because JSON/Excel files are better handled as raw files in Cloudinary for this purpose
                        const result = await uploadToCloudinary(file, 'documents_upload', null, null, 'raw');
                        
                        if (result && result.secure_url) {
                            showStatus(`Traitement du fichier en cours...`, false);
                            await sendToBackend(result.secure_url, type);
                        } else {
                            throw new Error("Échec de l'upload Cloudinary");
                        }
                    } catch (error) {
                        console.error('Erreur:', error);
                        showStatus(`Erreur: ${error.message || "Erreur d'upload"}`, true);
                    }
                    fileInput.value = '';
                }

                async function sendToBackend(fileUrl, type) {
                    const formData = new FormData();
                    formData.append('file_url', fileUrl); // Send URL
                    formData.append('type', type);
                    formData.append('filiere', '{{ selected_filiere }}'); // Ensure these vars exist
                    formData.append('annee', '{{ selected_annee }}');
                    formData.append('csrf_token', '{{ csrf_token() }}');

                    // Corrected route name: admin.import_emploi_temps
                    // Note: We are assuming the route name 'admin.import_emploi_temps' will be created.
                    const response = await fetch('{{ url_for("admin.import_emploi_temps") }}', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showStatus('✓ Importation réussie ! La page va se recharger...');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        throw new Error(result.error || 'Erreur lors de l\'importation');
                    }
                }
            
                function exportToExcel() {
                    const table = document.querySelector('table');
                    if (!table) {
                        showStatus('Aucun emploi du temps à exporter', true);
                        return;
                    }
            
                    const ws = XLSX.utils.table_to_sheet(table);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Emploi du temps');
            
                    const date = new Date().toISOString().split('T')[0];
                    const filename = `emploi_du_temps_${date}.xlsx`;
            
                    XLSX.writeFile(wb, filename);
                    showStatus(`✓ Fichier "${filename}" téléchargé avec succès !`);
                }
            
                // Validation avant soumission
                document.querySelector('form[method="post"]')?.addEventListener('submit', function (e) {
                    const confirmation = confirm('Êtes-vous sûr de vouloir enregistrer cet emploi du temps ?');
                    if (!confirmation) {
                        e.preventDefault();
                    }
                });
            
                // Ajouter un message de confirmation avant de quitter la page
                window.addEventListener('beforeunload', function (e) {
                    if (document.querySelector('.status-message:not(.success)')) {
                        e.preventDefault();
                        e.returnValue = 'Des modifications non enregistrées existent. Êtes-vous sûr de vouloir quitter ?';
                        return e.returnValue;
                    }
                });
            
                // Mettre à jour le message de statut lors des changements
                document.querySelectorAll('input[name^="cours_"]').forEach(input => {
                    input.addEventListener('change', function () {
                        const status = document.querySelector('.status-message');
                        if (status && !status.classList.contains('success')) {
                           // status.textContent = 'Modifications non enregistrées - Cliquez sur "Enregistrer" pour sauvegarder';
                           
                        }
                    });
                });
            </script>
{% endblock %}