<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{% endblock %}</title>

    <!-- Styles globaux -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/compiled.css') }}">

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="DEFITECH" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-TileColor" content="#2563eb" />
    <meta name="msapplication-tap-highlight" content="no" />

    <!-- PWA Manifest -->
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />

    <!-- Apple Touch Icons -->
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="{{ url_for('static', filename='images/icons/icon-152x152.png') }}"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ url_for('static', filename='images/icons/icon-192x192.png') }}"
    />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="{{ url_for('static', filename='images/icons/icon-192x192.png') }}"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      href="https://res.cloudinary.com/dmokvhpjt/image/upload/v1766894416/bijcryrbjli0daglbsim.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ url_for('static', filename='images/icons/icon-32x32.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ url_for('static', filename='images/icons/icon-16x16.png') }}"
    />

    <style>
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }

        100% {
          background-position: 1000px 0;
        }
      }

      .shimmer {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }

        50% {
          transform: translateY(-10px);
        }
      }

      .float-animation {
        animation: float 3s ease-in-out infinite;
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
      }

      .sidebar-glass {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(30px) saturate(200%);
        -webkit-backdrop-filter: blur(30px) saturate(200%);
      }

      @keyframes slideInRight {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }

        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .dropdown-menu {
        animation: slideDown 0.2s ease-out;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(156, 163, 175, 0.3);
        border-radius: 3px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(156, 163, 175, 0.5);
      }

      /* Rotation du chevron */
      .chevron-rotate {
        transition: transform 0.3s ease;
      }

      .chevron-rotate.open {
        transform: rotate(180deg);
      }

      /* Overlay pour mobile */
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 9997;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .sidebar-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* Animation sidebar mobile */
      #admin-sidebar {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #admin-sidebar.open {
        transform: translateX(0) !important;
      }

      /* Media queries pour xs */
      @media (min-width: 475px) {
        .xs\:inline {
          display: inline;
        }
      }
    </style>

    {% block extra_css %}{% endblock %}
  </head>

  <body
    class="bg-gradient-to-br from-gray-50 via-blue-50/30 to-gray-50 min-h-screen flex flex-col w-full font-['Inter'] antialiased"
  >
    <!-- Barre de progression -->
    {% include 'components/progress_bar.html' %}

    <!-- HEADER avec effet glassmorphism moderne -->
    <header
      class="fixed top-0 left-0 right-0 w-full glass-effect border-b border-white/50 shadow-lg shadow-blue-500/5 z-[9999] transition-all duration-300"
    >
      <nav class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Logo et navigation principale -->
          <div class="flex items-center space-x-2 sm:space-x-4 flex-1 min-w-0">
            <!-- Bouton menu mobile - Toujours visible pour admin -->
            {% if current_user.is_authenticated and current_user.role == 'admin'
            %}
            <button
              type="button"
              id="sidebar-toggle"
              class="p-2.5 rounded-xl text-gray-700 hover:text-blue-600 hover:bg-gradient-to-br hover:from-blue-50 hover:to-blue-100 transition-all duration-300 active:scale-95 focus:outline-none"
              aria-label="Toggle menu"
            >
              <i
                class="fas fa-bars text-xl transition-transform duration-300"
                id="sidebar-icon"
              ></i>
            </button>
            {% endif %}

            <a
              href="{{ url_for('main.index') }}"
              class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0 group"
            >
              <div class="relative">
                <div
                  class="absolute inset-0 bg-blue-500 rounded-xl blur-md opacity-30 group-hover:opacity-50 transition-opacity"
                ></div>
                <img
                  src="https://res.cloudinary.com/dmokvhpjt/image/upload/v1766894416/bijcryrbjli0daglbsim.png"
                  alt="Logo DEFITECH"
                  class="relative w-9 h-9 sm:w-10 sm:h-10 rounded-xl shadow-lg transition-transform group-hover:scale-110 group-hover:rotate-3"
                />
              </div>
              <span
                class="font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-600 text-lg sm:text-xl tracking-tight hidden xs:inline"
                >DEFITECH</span
              >
            </a>

            {% if current_user.is_authenticated %}
            <div class="hidden md:flex items-center space-x-1 min-w-0">
              <a
                href="{% if current_user.role == 'admin' %}{{ url_for('admin.dashboard') }}{% elif current_user.role == 'enseignant' %}{{ url_for('teachers.dashboard') }}{% elif current_user.role == 'etudiant' %}{{ url_for('students.dashboard') }}{% else %}#{% endif %}"
                class="group flex items-center text-gray-700 hover:text-blue-600 hover:bg-gradient-to-br hover:from-blue-50 hover:to-blue-100 transition-all duration-300 font-semibold text-sm px-4 py-2.5 rounded-xl whitespace-nowrap"
              >
                <i
                  class="fas fa-th-large mr-2 transition-transform group-hover:scale-110"
                ></i>
                <span class="hidden lg:inline">Dashboard</span>
              </a>
            </div>
            {% endif %}
          </div>

          <!-- Actions et menu utilisateur -->
          <div class="flex items-center space-x-2 sm:space-x-3">
            {% if current_user.is_authenticated %}
            <!-- Message de bienvenue - Optimisé mobile -->
            <div
              class="hidden sm:flex items-center space-x-2 px-3 py-2 bg-gradient-to-br from-gray-100 to-gray-50 rounded-xl border border-gray-200/50 shadow-sm"
            >
              <span
                class="text-gray-700 text-sm font-semibold max-w-[100px] md:max-w-[150px] lg:max-w-[200px] truncate"
                title="{{ current_user.nom }} {{ current_user.prenom }}"
              >
                {{ current_user.prenom }}
              </span>
            </div>

            <!-- Bouton PWA -->
            <button
              class="bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 hover:from-blue-700 hover:via-blue-800 hover:to-blue-900 text-white px-4 py-2.5 rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 transition-all duration-300 items-center gap-2 text-sm font-bold active:scale-95"
              id="pwaBtn"
              title="Installer l'application"
            >
              <i class="fas fa-download"></i>
              <span class="hidden md:block">Installer</span>
            </button>

            <!-- Menu utilisateur -->
            <div class="relative">
              <!-- Bouton avatar -->
              <button
                type="button"
                id="user-menu-button"
                class="relative bg-gradient-to-br from-white to-gray-50 hover:from-gray-50 hover:to-white rounded-xl flex items-center justify-center gap-2 px-3 py-2 shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden group active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                aria-label="Menu utilisateur"
                aria-expanded="false"
              >
                <img
                  src="{{ current_user.photo_profil if current_user.photo_profil else 'https://res.cloudinary.com/dmokvhpjt/image/upload/v1766894568/e4etekyaf1zlziwh60et.png' }}"
                  alt="Profil"
                  class="relative w-8 h-8 sm:w-9 sm:h-9 object-cover transition-transform group-hover:scale-110 rounded-full ring-2 ring-white"
                />
                <i
                  class="fas fa-chevron-down text-gray-600 text-sm chevron-rotate transition-transform"
                  id="user-menu-chevron"
                ></i>
              </button>

              <!-- Dropdown menu -->
              <div
                id="user-menu"
                class="hidden absolute right-0 mt-3 w-72 sm:w-80 rounded-2xl bg-white shadow-2xl shadow-gray-900/10 ring-1 ring-gray-200/50 overflow-hidden dropdown-menu"
              >
                <!-- Header avec info utilisateur -->
                <div
                  class="p-4 bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-700 border-b border-blue-500/30 relative overflow-hidden"
                >
                  <div class="absolute inset-0 opacity-10"></div>
                  <div class="relative">
                    <p class="text-sm font-bold text-white truncate mb-1">
                      {{ current_user.prenom }} {{ current_user.nom }}
                    </p>
                    <p class="text-xs text-blue-100 truncate flex items-center">
                      <i class="fas fa-envelope mr-1.5"></i>
                      {{ current_user.email }}
                    </p>
                  </div>
                </div>

                <!-- Liens du menu -->
                <div class="py-2">
                  <a
                    href="{{ url_for('profile.mon_profil') }}"
                    class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-blue-100 hover:text-blue-600 transition-all group"
                  >
                    <div
                      class="w-9 h-9 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-3 group-hover:scale-110 transition-transform"
                    >
                      <i class="fas fa-user-circle"></i>
                    </div>
                    <span class="font-medium">Mon profil</span>
                  </a>

                  <a
                    href="{{ url_for('chat.admin_chat') }}"
                    class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-blue-100 hover:text-blue-600 transition-all group"
                  >
                    <div
                      class="w-9 h-9 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-3 group-hover:scale-110 transition-transform"
                    >
                      <i class="fas fa-comments"></i>
                    </div>
                    <span class="font-medium">Chat</span>
                  </a>

                  <a
                    href="{{ url_for('main.index') }}"
                    class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-green-50 hover:to-green-100 hover:text-green-600 transition-all group"
                  >
                    <div
                      class="w-9 h-9 rounded-lg bg-green-100 text-green-600 flex items-center justify-center mr-3 group-hover:scale-110 transition-transform"
                    >
                      <i class="fas fa-home"></i>
                    </div>
                    <span class="font-medium">Accueil</span>
                  </a>

                  {% if current_user.role == 'admin' %}
                  <a
                    href="{{ url_for('admin.dashboard') }}"
                    class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-purple-50 hover:to-purple-100 hover:text-purple-600 transition-all group lg:hidden"
                  >
                    <div
                      class="w-9 h-9 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center mr-3 group-hover:scale-110 transition-transform"
                    >
                      <i class="fas fa-cog"></i>
                    </div>
                    <span class="font-medium">Administration</span>
                  </a>
                  {% endif %}
                </div>

                <hr class="border-gray-200" />

                <a
                  href="{{ url_for('auth.logout') }}"
                  class="flex items-center px-4 py-3 text-sm text-red-600 hover:bg-gradient-to-r hover:from-red-50 hover:to-red-100 transition-all group"
                >
                  <div
                    class="w-9 h-9 rounded-lg bg-red-100 text-red-600 flex items-center justify-center mr-3 group-hover:scale-110 transition-transform"
                  >
                    <i class="fas fa-sign-out-alt"></i>
                  </div>
                  <span class="font-medium">Déconnexion</span>
                </a>
              </div>
            </div>

            {% else %}
            <!-- Non authentifié -->
            <div class="flex items-center space-x-2 sm:space-x-3">
              <a
                href="{{ url_for('auth.login') }}"
                class="text-gray-700 hover:text-blue-600 font-semibold text-sm transition-colors whitespace-nowrap px-3 sm:px-4 py-2 rounded-xl hover:bg-gradient-to-br hover:from-gray-100 hover:to-gray-50"
              >
                Connexion
              </a>
              <a
                href="{{ url_for('auth.register') }}"
                class="bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 hover:from-blue-700 hover:via-blue-800 hover:to-blue-900 text-white px-3 sm:px-5 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 transition-all duration-300 whitespace-nowrap active:scale-95"
              >
                Inscription
              </a>
            </div>
            {% endif %} {% include 'components/notification_center.html' %}

            <!-- Indicateur de connexion -->
            <div
              id="connection-status"
              class="hidden xl:flex items-center space-x-2 ml-2 px-3 py-2 bg-gradient-to-br from-gray-100 to-gray-50 rounded-xl border border-gray-200/50 shadow-sm"
            >
              <div
                title="En ligne"
                id="connection-indicator"
                class="w-2 h-2 rounded-full bg-green-500 shadow-sm shadow-green-500/50 animate-pulse"
              ></div>
              <span
                id="connection-text"
                class="text-xs text-gray-700 font-semibold whitespace-nowrap"
                >En ligne</span
              >
            </div>
          </div>
        </div>
      </nav>
    </header>

    <!-- Overlay pour sidebar mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Curseur personnalisé -->
    <div
      id="cursor"
      class="fixed w-10 h-10 p-2 shadow-lg rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 backdrop-blur-sm z-[9999] pointer-events-none hidden lg:block"
      aria-hidden="true"
    ></div>

    <button
      id="defaiBtn"
      onclick="window.location.href='/defAI'"
      title="Defai Votre Assistant"
      class="w-12 h-12 z-[9999] rounded-full outline-none fixed bottom-4 right-4 shadow-lg hover:scale-110 transition-all duration-150"
    >
      <img
        src="https://res.cloudinary.com/dmokvhpjt/image/upload/v1766894468/gep1294qd7tbddgvtmpj.png"
        alt="logo"
      />
    </button>

    <!-- Sidebar Admin -->
    {% include 'components/sidebar.html' %}

    <!-- Contenu principal -->
    <main class="flex-grow w-full pt-20 bg-gray-50">
      <!-- Messages flash -->
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        {% for category, message in messages %}
        <div
          class="rounded-lg p-3 sm:p-4 mb-3 sm:mb-4 shadow-sm transition-all duration-300 {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}"
        >
          <div class="flex items-center space-x-2">
            {% if category == 'error' %}
            <i class="fas fa-exclamation-circle flex-shrink-0"></i>
            {% elif category == 'success' %}
            <i class="fas fa-check-circle flex-shrink-0"></i>
            {% else %}
            <i class="fas fa-info-circle flex-shrink-0"></i>
            {% endif %}
            <p class="text-xs sm:text-sm font-medium">{{ message }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %} {% block content %}{% endblock %}
    </main>

    <!-- Scripts JavaScript -->
    <script src="{{ url_for('static', filename='js/cloudinary_uploader.js') }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Gestion du menu utilisateur avec chevron
        const userMenuButton = document.getElementById("user-menu-button");
        const userMenu = document.getElementById("user-menu");
        const userMenuChevron = document.getElementById("user-menu-chevron");

        const btn = document.getElementById("defaiBtn");

        let dragging = false;
        let offsetX = 0;
        let offsetY = 0;

        function startDrag(x, y) {
          dragging = true;
          offsetX = x - btn.offsetLeft;
          offsetY = y - btn.offsetTop;
          btn.style.transition = "none"; // désactive l'animation pendant le drag
          btn.style.cursor = "grabbing";
        }

        function moveDrag(x, y) {
          if (!dragging) return;

          btn.style.left = x - offsetX + "px";
          btn.style.top = y - offsetY + "px";
        }

        function endDrag() {
          if (!dragging) return;
          dragging = false;
          btn.style.cursor = "grab";
          btn.style.transition = "all 0.25s ease"; // réactive l’animation pour le snapping

          snapToCorner();
        }

        function snapToCorner() {
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          const bw = btn.offsetWidth;
          const bh = btn.offsetHeight;

          const x = btn.offsetLeft;
          const y = btn.offsetTop;

          const dist = {
            tl: Math.hypot(x, y),
            tr: Math.hypot(vw - x - bw, y),
            bl: Math.hypot(x, vh - y - bh),
            br: Math.hypot(vw - x - bw, vh - y - bh),
          };

          const nearest = Object.entries(dist).sort(
            (a, b) => a[1] - b[1]
          )[0][0];

          switch (nearest) {
            case "tl":
              btn.style.left = "10px";
              btn.style.top = "10px";
              break;
            case "tr":
              btn.style.left = vw - bw - 10 + "px";
              btn.style.top = "10px";
              break;
            case "bl":
              btn.style.left = "10px";
              btn.style.top = vh - bh - 10 + "px";
              break;
            case "br":
              btn.style.left = vw - bw - 10 + "px";
              btn.style.top = vh - bh - 10 + "px";
              break;
          }
        }

        /* -------------------- PC (mouse) -------------------- */
        btn.addEventListener("mousedown", (e) =>
          startDrag(e.clientX, e.clientY)
        );
        document.addEventListener("mousemove", (e) =>
          moveDrag(e.clientX, e.clientY)
        );
        document.addEventListener("mouseup", endDrag);

        /* -------------------- Mobile (touch) -------------------- */
        btn.addEventListener("touchstart", (e) => {
          const t = e.touches[0];
          startDrag(t.clientX, t.clientY);
        });

        document.addEventListener("touchmove", (e) => {
          const t = e.touches[0];
          moveDrag(t.clientX, t.clientY);
        });

        document.addEventListener("touchend", endDrag);

        if (userMenuButton && userMenu) {
          userMenuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            const isHidden = userMenu.classList.contains("hidden");

            if (isHidden) {
              userMenu.classList.remove("hidden");
              userMenuChevron.classList.add("open");
              userMenuButton.setAttribute("aria-expanded", "true");
            } else {
              userMenu.classList.add("hidden");
              userMenuChevron.classList.remove("open");
              userMenuButton.setAttribute("aria-expanded", "false");
            }
          });

          // Fermer le menu en cliquant à l'extérieur
          document.addEventListener("click", function (e) {
            if (
              !userMenuButton.contains(e.target) &&
              !userMenu.contains(e.target)
            ) {
              userMenu.classList.add("hidden");
              userMenuChevron.classList.remove("open");
              userMenuButton.setAttribute("aria-expanded", "false");
            }
          });

          // Fermer avec la touche Escape
          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape" && !userMenu.classList.contains("hidden")) {
              userMenu.classList.add("hidden");
              userMenuChevron.classList.remove("open");
              userMenuButton.setAttribute("aria-expanded", "false");
            }
          });
        }

        // Gestion de la sidebar admin
        const sidebarToggle = document.getElementById("sidebar-toggle");
        const adminSidebar = document.getElementById("admin-sidebar");
        const sidebarOverlay = document.getElementById("sidebar-overlay");
        const sidebarIcon = document.getElementById("sidebar-icon");

        if (sidebarToggle && adminSidebar) {
          // Toggle sidebar
          sidebarToggle.addEventListener("click", function () {
            const isOpen = adminSidebar.classList.contains("open");

            if (isOpen) {
              closeSidebar();
            } else {
              openSidebar();
            }
          });

          // Fermer en cliquant sur l'overlay
          if (sidebarOverlay) {
            sidebarOverlay.addEventListener("click", closeSidebar);
          }

          // Fermer avec Escape
          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape" && adminSidebar.classList.contains("open")) {
              closeSidebar();
            }
          });

          function openSidebar() {
            adminSidebar.classList.add("open");
            if (sidebarOverlay) {
              sidebarOverlay.classList.add("active");
            }
            if (sidebarIcon) {
              sidebarIcon.classList.remove("fa-bars");
              sidebarIcon.classList.add("fa-times");
            }
            document.body.style.overflow = "hidden";
          }

          function closeSidebar() {
            adminSidebar.classList.remove("open");
            if (sidebarOverlay) {
              sidebarOverlay.classList.remove("active");
            }
            if (sidebarIcon) {
              sidebarIcon.classList.remove("fa-times");
              sidebarIcon.classList.add("fa-bars");
            }
            document.body.style.overflow = "";
          }

          // Fermer la sidebar automatiquement sur les grands écrans au redimensionnement
          let resizeTimer;
          window.addEventListener("resize", function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
              if (
                window.innerWidth >= 1024 &&
                adminSidebar.classList.contains("open")
              ) {
                closeSidebar();
              }
            }, 250);
          });
        }

        // Curseur personnalisé (desktop uniquement)
        const cursor = document.getElementById("cursor");
        if (cursor && window.innerWidth >= 1024) {
          let mouseX = 0,
            mouseY = 0;
          let cursorX = 0,
            cursorY = 0;
          const speed = 0.15;

          document.addEventListener("mousemove", function (e) {
            mouseX = e.clientX;
            mouseY = e.clientY;
          });

          function animateCursor() {
            const distX = mouseX - cursorX;
            const distY = mouseY - cursorY;

            cursorX += distX * speed;
            cursorY += distY * speed;

            cursor.style.left = cursorX + "px";
            cursor.style.top = cursorY + "px";

            requestAnimationFrame(animateCursor);
          }

          animateCursor();

          // Effet sur les liens et boutons
          const interactiveElements = document.querySelectorAll(
            "a, button, input, textarea, select"
          );
          interactiveElements.forEach((el) => {
            el.addEventListener("mouseenter", () => {
              cursor.style.transform = "scale(1.5)";
              cursor.style.backgroundColor = "rgba(59, 130, 246, 0.3)";
            });
            el.addEventListener("mouseleave", () => {
              cursor.style.transform = "scale(1)";
              cursor.style.backgroundColor = "rgba(59, 130, 246, 0.2)";
            });
          });
        }

        // Gestion du statut de connexion
        const connectionIndicator = document.getElementById(
          "connection-indicator"
        );
        const connectionText = document.getElementById("connection-text");

        function updateConnectionStatus() {
          if (navigator.onLine) {
            if (connectionIndicator) {
              connectionIndicator.classList.remove(
                "bg-red-500",
                "shadow-red-500/50"
              );
              connectionIndicator.classList.add(
                "bg-green-500",
                "shadow-green-500/50",
                "animate-pulse"
              );
            }
            if (connectionText) {
              connectionText.textContent = "En ligne";
            }
          } else {
            if (connectionIndicator) {
              connectionIndicator.classList.remove(
                "bg-green-500",
                "shadow-green-500/50",
                "animate-pulse"
              );
              connectionIndicator.classList.add(
                "bg-red-500",
                "shadow-red-500/50"
              );
            }
            if (connectionText) {
              connectionText.textContent = "Hors ligne";
            }
          }
        }

        window.addEventListener("online", updateConnectionStatus);
        window.addEventListener("offline", updateConnectionStatus);
        updateConnectionStatus();

        // PWA Installation
        let deferredPrompt;
        const pwaBtn = document.getElementById("pwaBtn");

        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          if (pwaBtn) {
            pwaBtn.style.display = "flex";
          }
        });

        if (pwaBtn) {
          pwaBtn.addEventListener("click", async () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              console.log(`User response: ${outcome}`);
              deferredPrompt = null;
              pwaBtn.style.display = "none";
            }
          });
        }

        window.addEventListener("appinstalled", () => {
          console.log("PWA installée avec succès");
          if (pwaBtn) {
            pwaBtn.style.display = "none";
          }
        });

        // Service Worker Registration
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("/static/js/sw.js")
            .then((registration) => {
              console.log(
                "Service Worker enregistré avec succès:",
                registration
              );
            })
            .catch((error) => {
              console.log(
                `Erreur lors de l'enregistrement du Service Worker:`,
                error
              );
            });
        }

        // Smooth scroll pour les ancres
        document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
          anchor.addEventListener("click", function (e) {
            const href = this.getAttribute("href");
            if (href !== "#" && href !== "#!") {
              e.preventDefault();
              const target = document.querySelector(href);
              if (target) {
                target.scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                });
              }
            }
          });
        });

        // Animation au scroll pour les éléments
        const observerOptions = {
          threshold: 0.1,
          rootMargin: "0px 0px -50px 0px",
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = "1";
              entry.target.style.transform = "translateY(0)";
            }
          });
        }, observerOptions);

        // Appliquer l'observation aux éléments avec classe animate-on-scroll
        document.querySelectorAll(".animate-on-scroll").forEach((el) => {
          el.style.opacity = "0";
          el.style.transform = "translateY(20px)";
          el.style.transition = "opacity 0.3s ease, transform 0.3s ease";
          observer.observe(el);
        });
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
