<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messagerie - Support</title>
  
  <!-- Styles globaux -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/compiled.css') }}">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .chat-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .chat-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-scroll::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    /* Message Bubbles */
    .msg-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      animation: slideUp 0.3s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    .msg-sent {
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }

    .msg-received {
      background: #334155;
      color: #f1f5f9;
      border-bottom-left-radius: 4px;
    }

    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .typing-dot {
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }
  </style>
</head>

<body class="bg-slate-900 h-screen flex flex-col text-slate-100 overflow-hidden">

  <!-- Header -->
  <header class="h-16 glass-panel flex items-center justify-between px-4 z-20 shadow-lg">
    <div class="flex items-center gap-4">
      <a href="/"
        class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/5 transition-colors text-slate-400 hover:text-white">
        <i class="fas fa-arrow-left"></i>
      </a>

      <div class="flex items-center gap-3">
        <!-- Admin Avatar -->
        <div class="relative">
          {% if admin.photo_profil %}
          <img src="{{ url_for('static', filename='uploads/profile_pics/' + admin.photo_profil) }}"
            class="w-10 h-10 rounded-full object-cover border border-slate-600">
          {% else %}
          <div
            class="w-10 h-10 rounded-full bg-blue-600/20 text-blue-400 flex items-center justify-center border border-blue-500/30">
            <i class="fas fa-headset"></i>
          </div>
          {% endif %}
          <div id="status-indicator"
            class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full"></div>
        </div>

        <div>
          <h1 class="font-semibold text-sm">{{ admin.prenom }} {{ admin.nom }}</h1>
          <div class="flex items-center gap-2 text-xs text-slate-400 h-4">
            <span id="typing-status" class="hidden items-center gap-1 text-blue-400">
              <span class="w-1 h-1 bg-current rounded-full typing-dot"></span>
              <span class="w-1 h-1 bg-current rounded-full typing-dot"></span>
              <span class="w-1 h-1 bg-current rounded-full typing-dot"></span>
              écrit...
            </span>
            <span id="online-text">Support Admin</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-2">
      <button onclick="clearChat()"
        class="w-10 h-10 rounded-full hover:bg-white/5 text-slate-400 hover:text-red-400 transition-colors"
        title="Effacer l'historique local">
        <i class="fas fa-trash-alt"></i>
      </button>
    </div>
  </header>

  <!-- Chat Area -->
  <main id="chat-container" class="flex-1 overflow-y-auto chat-scroll p-4 space-y-4 relative">
    <!-- Empty State -->
    <div id="empty-state"
      class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none">
      <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-4 text-3xl">
        <i class="fas fa-comments"></i>
      </div>
      <p>Commencez la conversation avec le support</p>
    </div>

    <!-- Messages injected here -->
    <div id="messages-list" class="space-y-4 pb-4"></div>
  </main>

  <!-- Input Area -->
  <footer class="p-4 glass-panel z-20">
    <form id="chat-form" class="flex items-end gap-3 max-w-4xl mx-auto">
      <div
        class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500 transition-all">
        <textarea id="message-input" rows="1" placeholder="Écrivez votre message..."
          class="w-full bg-transparent text-white px-4 py-3 focus:outline-none resize-none max-h-32"
          oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 128) + 'px'"></textarea>
      </div>
      <button type="submit" id="send-btn"
        class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center shadow-lg shadow-blue-600/20 transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </footer>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script>
    const CONFIG = {
      adminId: {{ admin.id }},
    userId: { { current_user.id } },
    userAvatar: "{{ current_user.photo_profil or '' }}",
      adminAvatar: "{{ admin.photo_profil or '' }}"
        };

    // DOM Elements
    const DOM = {
      form: document.getElementById('chat-form'),
      input: document.getElementById('message-input'),
      list: document.getElementById('messages-list'),
      container: document.getElementById('chat-container'),
      empty: document.getElementById('empty-state'),
      typing: document.getElementById('typing-status'),
      online: document.getElementById('online-text'),
      sendBtn: document.getElementById('send-btn')
    };

    // Socket Initialization
    const socket = io();
    let typingTimeout;

    // ==========================================
    // SOCKET EVENTS
    // ==========================================
    socket.on('connect', () => {
      console.log('Connected to chat');
      loadHistory();
    });

    socket.on('receive_message', (data) => {
      appendMessage({
        content: data.content,
        isMe: false,
        timestamp: data.timestamp
      });
      playNotificationSound();
    });

    socket.on('message_sent', (data) => {
      // Already appended optimistically usually, but can confirm here
    });

    socket.on('user_typing', (data) => {
      if (data.user_id === CONFIG.adminId) {
        toggleTyping(data.is_typing);
      }
    });

    // ==========================================
    // UI FUNCTIONS
    // ==========================================
    DOM.form.addEventListener('submit', (e) => {
      e.preventDefault();
      sendMessage();
    });

    DOM.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
      // Emit typing
      socket.emit('typing', { receiver_id: CONFIG.adminId, is_typing: true });
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('typing', { receiver_id: CONFIG.adminId, is_typing: false });
      }, 1000);
    });

    function sendMessage() {
      const text = DOM.input.value.trim();
      if (!text) return;

      // Optimistic Update
      appendMessage({
        content: text,
        isMe: true,
        timestamp: new Date().toISOString()
      });

      socket.emit('send_message', {
        receiver_id: CONFIG.adminId,
        content: text
      });

      DOM.input.value = '';
      DOM.input.style.height = 'auto';
    }

    function appendMessage({ content, isMe, timestamp }) {
      DOM.empty.style.display = 'none';

      const div = document.createElement('div');
      div.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;

      const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      div.innerHTML = `
                <div class="msg-bubble ${isMe ? 'msg-sent' : 'msg-received'} group">
                    <div class="whitespace-pre-wrap break-words text-sm sm:text-base">${escapeHtml(content)}</div>
                    <div class="text-[10px] mt-1 opacity-70 ${isMe ? 'text-blue-100' : 'text-slate-400'} flex items-center justify-end gap-1">
                        ${time}
                        ${isMe ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                </div>
            `;

      DOM.list.appendChild(div);
      scrollToBottom();
    }

    function toggleTyping(isTyping) {
      DOM.typing.style.display = isTyping ? 'flex' : 'none';
      DOM.online.style.display = isTyping ? 'none' : 'block';
    }

    function scrollToBottom() {
      DOM.container.scrollTop = DOM.container.scrollHeight;
    }

    async function loadHistory() {
      try {
        const res = await fetch(`/chat/api/history?with=${CONFIG.adminId}`);
        const data = await res.json();

        if (data.success && data.messages.length > 0) {
          DOM.list.innerHTML = ''; // Clear
          data.messages.forEach(msg => {
            appendMessage({
              content: msg.content,
              isMe: msg.sender_id === CONFIG.userId,
              timestamp: msg.timestamp
            });
          });
        }
      } catch (e) {
        console.error('History load failed', e);
      }
    }

    // Utils
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function playNotificationSound() {
      // Optional beep
    }

    function clearChat() {
      if (confirm('Effacer l\'affichage local ?')) {
        DOM.list.innerHTML = '';
        DOM.empty.style.display = 'flex';
      }
    }
  </script>
</body>

</html>