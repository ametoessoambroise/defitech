
<!-- Loading Component - Intercepts all navigation redirects -->
<div
  id="globalLoader"
  class="fixed inset-0 bg-white dark:bg-gray-900 z-[9999] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none"
>
  <div class="text-center">
    <!-- Spinner Animation -->
    <div class="relative">
      <div
        class="w-20 h-20 border-4 border-primary-200 dark:border-primary-900 rounded-full animate-pulse"
      ></div>
      <div
        class="absolute top-0 left-0 w-20 h-20 border-4 border-transparent border-t-primary-600 dark:border-t-primary-400 rounded-full animate-spin"
      ></div>
    </div>

    <!-- Loading Text -->
    <p
      class="mt-6 text-lg font-medium text-gray-700 dark:text-gray-300 animate-pulse"
    >
      Chargement en cours...
    </p>

    <!-- Progress Bar -->
    <div
      class="mt-4 w-64 h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"
    >
      <div
        class="h-full bg-gradient-to-r from-primary-500 to-primary-600 animate-progress"
      ></div>
    </div>
  </div>
</div>

<style>
  @keyframes progress {
    0% {
      width: 0%;
      margin-left: 0%;
    }
    50% {
      width: 75%;
      margin-left: 0%;
    }
    100% {
      width: 0%;
      margin-left: 100%;
    }
  }

  .animate-progress {
    animation: progress 2s ease-in-out infinite;
  }

  #globalLoader.active {
    opacity: 1;
    pointer-events: auto;
  }
</style>

<script>
  (function () {
    "use strict";

    const loader = document.getElementById("globalLoader");
    let isNavigating = false;

    // Show loader
    function showLoader() {
      if (!isNavigating) {
        isNavigating = true;
        loader.classList.add("active");
      }
    }

    // Hide loader
    function hideLoader() {
      isNavigating = false;
      loader.classList.remove("active");
    }

    // Check if URL is internal anchor
    function isInternalAnchor(href) {
      return (
        href &&
        (href.startsWith("#") ||
          href === "javascript:void(0)" ||
          href === "javascript:;")
      );
    }

    // Check if URL is external
    function isExternal(url) {
      try {
        const link = new URL(url, window.location.origin);
        return link.hostname !== window.location.hostname;
      } catch (e) {
        return false;
      }
    }

    // Intercept clicks on links
    document.addEventListener(
      "click",
      function (e) {
        // Find the closest anchor element
        const anchor = e.target.closest("a");

        if (anchor && anchor.href) {
          const href = anchor.getAttribute("href");
          const target = anchor.getAttribute("target");

          // Skip internal anchors
          if (isInternalAnchor(href)) {
            return;
          }

          // Skip if opens in new tab
          if (target === "_blank" || target === "_new") {
            return;
          }

          // Skip if it's an external link
          if (isExternal(anchor.href)) {
            return;
          }

          // Skip if it has data-no-loader attribute
          if (anchor.hasAttribute("data-no-loader")) {
            return;
          }

          // Show loader for valid navigation
          showLoader();
        }

        // Intercept buttons with onclick that navigate
        const button = e.target.closest("button");
        if (
          button &&
          button.type !== "submit" &&
          button.type !== "reset" &&
          button.hasAttribute("onclick")
        ) {
          const onclickAttr = button.getAttribute("onclick") || "";
          if (
            onclickAttr.includes("location.href") ||
            onclickAttr.includes("window.location")
          ) {
            showLoader();
          }
        }
      },
      true
    );

    // Intercept form submissions
    document.addEventListener(
      "submit",
      function (e) {
        const form = e.target;

        // Skip AJAX forms
        if (
          form.hasAttribute("data-ajax") ||
          form.hasAttribute("data-no-loader")
        ) {
          return;
        }

        // Show loader for regular form submissions
        showLoader();
      },
      true
    );

    // Hide loader when page is fully loaded (fallback)
    window.addEventListener("load", function () {
      // Small delay to ensure smooth transition
      setTimeout(hideLoader, 100);
    });

    // Hide loader on page show (back/forward navigation)
    window.addEventListener("pageshow", function (event) {
      if (event.persisted) {
        hideLoader();
      }
    });

    // Hide loader if navigation is cancelled
    window.addEventListener("beforeunload", function () {
      // Keep loader visible during actual navigation
    });

    // Fallback: hide loader after 10 seconds to prevent stuck state
    let loaderTimeout;
    const originalShowLoader = showLoader;
    showLoader = function () {
      originalShowLoader();
      clearTimeout(loaderTimeout);
      loaderTimeout = setTimeout(function () {
        console.warn("Loader timeout - hiding loader");
        hideLoader();
      }, 10000);
    };

    // Override window.location for programmatic navigation
    const originalLocationHref = Object.getOwnPropertyDescriptor(
      window.location,
      "href"
    );
    Object.defineProperty(window.location, "href", {
      set: function (url) {
        if (!isInternalAnchor(url)) {
          showLoader();
        }
        originalLocationHref.set.call(this, url);
      },
      get: originalLocationHref.get,
    });
  })();
</script>
