{% extends "base.html" %} {% block title %}{{ current_user.nom }} {{
current_user.prenom }} | DEFITECH{% endblock %} {% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white rounded-lg shadow">
    <div
      class="px-6 py-4 border-b border-gray-200 flex items-center justify-between"
    >
      <div>
        <h2 class="text-xl font-semibold text-gray-900">Mon Emploi du Temps</h2>
        <p class="text-sm text-gray-600 mt-1">
          Consultez votre planning hebdomadaire
        </p>
      </div>
      <button
        id="refresh-emploi"
        class="inline-flex items-center px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
      >
        <i class="fas fa-sync-alt mr-2"></i>Actualiser
      </button>
    </div>

    <div class="p-6">
      <div class="overflow-x-auto">
        <table
          id="timetable-enseignant"
          class="min-w-full border border-gray-200"
        >
          <thead id="timetable-head-enseignant">
            <!-- Rempli via JS -->
          </thead>
          <tbody
            id="timetable-body-enseignant"
            class="bg-white divide-y divide-gray-200"
          >
            <!-- Rempli via JS -->
          </tbody>
        </table>
      </div>

      <!-- Légende -->
      <div class="mt-6 p-4 bg-gray-50 rounded-lg">
        <h4 class="font-medium text-gray-900 mb-3">Légende</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="flex items-center">
            <div class="w-4 h-4 bg-blue-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Cours magistral</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-pink-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Travaux pratiques</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Laboratoire</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-cyan-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Sport</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const head = document.getElementById("timetable-head-enseignant");
    const body = document.getElementById("timetable-body-enseignant");
    const refreshBtn = document.getElementById("refresh-emploi");
    let isLoading = false;

    async function loadEmploiTempsEnseignant() {
      if (!head || !body || isLoading) return;
      isLoading = true;

      try {
        const response = await fetch(
          "{{ url_for('teachers.api_emploi_temps') }}"
        );
        if (!response.ok) {
          console.error("Erreur API enseignant:", response.statusText);
          isLoading = false;
          return;
        }

        const data = await response.json();

        // Vider le tableau JUSTE AVANT de le remplir
        head.innerHTML = "";
        body.innerHTML = "";

        const jours = data.jours || [];
        const horaires = data.horaires || [];
        const creneaux = data.creneaux || [];

        // Entête
        const headerRow = document.createElement("tr");
        headerRow.className = "bg-gray-50";

        const thHoraire = document.createElement("th");
        thHoraire.className =
          "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200";
        thHoraire.textContent = "Horaire";
        headerRow.appendChild(thHoraire);

        jours.forEach((jour) => {
          const th = document.createElement("th");
          th.className =
            "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200";
          th.textContent = jour;
          headerRow.appendChild(th);
        });

        head.appendChild(headerRow);

        const horaireConfig = data.horaire_config || [];

        horaireConfig.forEach((config) => {
          const row = document.createElement("tr");
          row.className =
            config.type === "pause"
              ? "bg-gray-50"
              : "hover:bg-blue-50/30 transition-colors";

          const tdHoraire = document.createElement("td");
          tdHoraire.className =
            "px-4 py-4 text-sm font-bold text-gray-900 border border-gray-200 text-center bg-gray-50/50";
          tdHoraire.innerHTML = `
            <div class="flex flex-col items-center gap-1">
              <i class="fas fa-clock text-blue-500 text-[10px]"></i>
              <span>${config.label}</span>
            </div>
          `;
          row.appendChild(tdHoraire);

          jours.forEach((jour) => {
            const td = document.createElement("td");
            td.className = "px-4 py-3 border border-gray-200 min-w-[150px]";

            if (config.type === "pause") {
              td.className += " bg-gray-50/30";
              td.innerHTML = `
                    <div class="flex items-center justify-center gap-2 text-gray-400">
                        <i class="fas ${
                          config.nom === "Déjeuner"
                            ? "fa-utensils"
                            : "fa-coffee"
                        } text-[10px]"></i>
                        <span class="text-[9px] font-black uppercase tracking-widest">${
                          config.nom
                        }</span>
                    </div>
                `;
            } else {
              const match = creneaux.find(
                (c) => c.jour === jour && c.horaire === config.label
              );
              if (match) {
                const div = document.createElement("div");
                div.className =
                  "bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500 p-3 rounded-r-lg shadow-sm";
                div.innerHTML = `
                    <p class="font-bold text-blue-900 text-sm mb-1">${
                      match.matiere || ""
                    }</p>
                    <div class="flex flex-wrap gap-1 mb-2">
                        <span class="px-1.5 py-0.5 bg-blue-200/50 text-blue-800 text-[9px] font-bold rounded uppercase tracking-tighter">
                            ${match.filiere}
                        </span>
                        <span class="px-1.5 py-0.5 bg-indigo-200/50 text-indigo-800 text-[9px] font-bold rounded uppercase tracking-tighter">
                            ${match.annee}
                        </span>
                    </div>
                    <div class="flex items-center gap-2 text-blue-700">
                        <i class="fas fa-door-open text-[10px]"></i>
                        <span class="text-xs font-medium">${
                          match.salle || "Non définie"
                        }</span>
                    </div>
                  `;
                td.appendChild(div);
              } else {
                td.innerHTML =
                  '<div class="h-12 flex items-center justify-center opacity-10"><i class="fas fa-minus text-gray-300"></i></div>';
              }
            }

            row.appendChild(td);
          });

          body.appendChild(row);
        });
      } catch (error) {
        console.error("Erreur chargement emploi du temps enseignant:", error);
      } finally {
        isLoading = false;
      }
    }

    refreshBtn?.addEventListener("click", function () {
      loadEmploiTempsEnseignant();
    });

    loadEmploiTempsEnseignant();
  });
</script>

{% endblock %}
