{% extends "base.html" %} {% block title %}{{ current_user.nom }} {{
current_user.prenom }} | DEFITECH{% endblock %} {% block content %}
<!-- Toast notifications -->
{% set js_messages = get_flashed_messages(with_categories=true) %}
<!-- <div
  id="toast-container"
  class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-xs"
></div>
<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.4s;
    transition: opacity 0.4s;
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function () {
      const messages = {{ js_messages| tojson | safe
  }};
  const colors = {
      success: 'bg-green-500 text-white',
      error: 'bg-red-500 text-white',
      warning: 'bg-yellow-400 text-gray-900',
      info: 'bg-blue-500 text-white',
  };
  const container = document.getElementById('toast-container');
  messages.forEach((msg, i) => {
      const toast = document.createElement('div');
      toast.className = `flex items-center justify-between px-4 py-3 rounded shadow mb-2 animate-fade-in ${colors[msg[0]] || colors.info}`;
      toast.style.opacity = 0;
      toast.innerHTML = `
      <span class="flex-1 pr-2">${msg[1]}</span>
      <button class="ml-2 text-xl font-bold focus:outline-none" aria-label="Fermer">&times;</button>
    `;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = 1; }, 100);
      // Fermeture manuelle
      toast.querySelector('button').onclick = () => {
          toast.style.opacity = 0;
          setTimeout(() => toast.remove(), 400);
      };
      // Fermeture auto
      setTimeout(() => {
          toast.style.opacity = 0;
          setTimeout(() => toast.remove(), 400);
      }, 4000 + i * 200);
  });
  });
</script> -->

<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-2xl font-bold mb-6">
    Envoyer un devoir, exercice, examen ou communiqué
  </h1>
  <form method="POST" class="bg-white rounded shadow p-6 space-y-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div>
      <label class="block text-sm font-medium text-gray-700">Type</label>
      <select name="type" required class="border rounded px-2 py-1 w-full">
        <option value="devoir">Devoir</option>
        <option value="exercice">Exercice</option>
        <option value="examen">Examen</option>
        <option value="communiqué">Communiqué</option>
      </select>
    </div>
    <div class="flex gap-4">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700">Filière</label>
        <select name="filiere" required class="border rounded px-2 py-1 w-full">
          {% for f in filieres %}
          <option value="{{ f }}">{{ f }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700">Année</label>
        <select name="annee" required class="border rounded px-2 py-1 w-full">
          {% for a in annees %}
          <option value="{{ a }}">{{ a }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Titre</label>
      <input
        type="text"
        name="titre"
        required
        class="border rounded px-2 py-1 w-full"
      />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Description</label>
      <textarea
        name="description"
        required
        class="border rounded px-2 py-1 w-full"
        rows="3"
      ></textarea>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700"
        >Date limite (optionnel)</label
      >
      <input
        type="date"
        name="date_limite"
        class="border rounded px-2 py-1 w-full"
      />
    </div>

    <!-- Cloudinary Upload Section -->
    <div>
      <label class="block text-sm font-medium text-gray-700"
        >Fichier à envoyer (pdf, docx, xlsx, jpg, png, mp4, etc.)</label
      >
      <div class="mt-1 flex items-center space-x-4">
        <label
          for="file-upload"
          class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          <span>Choisir un fichier</span>
          <input
            id="file-upload"
            type="file"
            class="sr-only"
            accept=".pdf,.docx,.xlsx,.jpg,.jpeg,.png,.ico,.avif,.mp4,.avi,.mov"
          />
        </label>
        <span id="file-name" class="text-sm text-gray-500"
          >Aucun fichier choisi</span
        >
      </div>

      <!-- Hidden inputs for Cloudinary data -->
      <input type="hidden" name="file_url" id="file_url" />
      <input type="hidden" name="file_type" id="file_type" />
      <input type="hidden" name="file_size" id="file_size" />
      <input type="hidden" name="file_format" id="file_format" />
      <input type="hidden" name="original_filename" id="original_filename" />

      <div id="upload_feedback" class="mt-2 text-sm"></div>
    </div>

    <button
      type="submit"
      id="submit-btn"
      class="bg-blue-600 text-white px-4 py-2 rounded"
    >
      Envoyer
    </button>
  </form>
</div>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/cloudinary_uploader.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Use the global helper to attach upload behavior
    // Using 'documents_upload' preset for generic files, and 'auto' resource type
    attachCloudinaryUpload(
      "file-upload",
      "file_url",
      "documents_upload",
      "upload_feedback",
      "auto"
    );

    // Add specific listener to populate other metadata fields
    const fileInput = document.getElementById("file-upload");
    fileInput.addEventListener("change", async function () {
      if (this.files.length > 0) {
        document.getElementById("file-name").textContent = this.files[0].name;
        document.getElementById("original_filename").value = this.files[0].name;
        document.getElementById("file_size").value = this.files[0].size;
        const extension = this.files[0].name.split(".").pop().toLowerCase();
        document.getElementById("file_format").value = extension;

        // Disable submit button during upload
        const submitBtn = document.getElementById("submit-btn");
        submitBtn.disabled = true;
        submitBtn.classList.add("opacity-50", "cursor-not-allowed");

        // Monitor the feedback element to re-enable
        const observer = new MutationObserver(function (mutations) {
          if (
            document.getElementById("upload_feedback").innerHTML.includes("✅")
          ) {
            submitBtn.disabled = false;
            submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
            // Extract the URL from the hidden input if needed, but attachCloudinaryUpload handles it
          }
        });
        observer.observe(document.getElementById("upload_feedback"), {
          childList: true,
          subtree: true,
        });
      }
    });
  });
</script>
{% endblock %} {% endblock %}
